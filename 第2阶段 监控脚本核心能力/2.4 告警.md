明白了 ✅，我们把重点放在 **发送告警通知**，这是 SRE 监控体系中最关键的一环。
告警通知的核心目标是：**当指标超过阈值时，立即通知相关负责人或团队**。

---

## 🧭 告警通知方式

| 方式         | Python 技术/库         | 说明                     |
| ---------- | ------------------- | ---------------------- |
| 飞书机器人      | `requests`          | 支持文本、富文本消息，直接推送到群      |
| 邮件         | `smtplib` + `email` | 传统邮件告警，支持 HTML/附件      |
| Slack / 钉钉 | `requests`          | 企业聊天工具，HTTP Webhook 推送 |
| 系统告警       | `subprocess`        | 触发系统通知或日志报警            |

---

## 🔹 飞书告警示例（最常用）

```python
import requests
import json
from datetime import datetime

FEISHU_WEBHOOK = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxx-xxxx-xxxx"

def send_feishu_alert(service_name, metric, value, threshold):
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    if value > threshold:
        text = f"[{now}] ⚠️ 服务 {service_name} {metric} 超过阈值！当前 {value}%"
    else:
        text = f"[{now}] ✅ 服务 {service_name} {metric} 正常，当前 {value}%"

    payload = {"msg_type": "text", "content": {"text": text}}
    headers = {"Content-Type": "application/json"}

    try:
        response = requests.post(FEISHU_WEBHOOK, headers=headers, data=json.dumps(payload), timeout=5)
        if response.status_code != 200:
            print(f"飞书发送失败: {response.text}")
    except Exception as e:
        print(f"发送异常: {e}")

# 测试
send_feishu_alert("payment", "CPU", 88, 80)
```

✅ 输出示例（飞书群消息）：

```
[2025-10-26 09:30:00] ⚠️ 服务 payment CPU 超过阈值！当前 88%
```

---

## 🔹 邮件告警示例

```python
import smtplib
from email.mime.text import MIMEText

SMTP_SERVER = "smtp.example.com"
SMTP_PORT = 25
FROM_EMAIL = "monitor@example.com"
TO_EMAIL = "admin@example.com"

def send_email_alert(subject, content):
    msg = MIMEText(content, "plain", "utf-8")
    msg['Subject'] = subject
    msg['From'] = FROM_EMAIL
    msg['To'] = TO_EMAIL

    try:
        server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
        server.send_message(msg)
        server.quit()
        print("邮件告警已发送")
    except Exception as e:
        print(f"邮件发送失败: {e}")

# 测试
send_email_alert("CPU 告警", "服务 payment CPU 超过阈值！当前 88%")
```

---

## 🔹 告警发送最佳实践

1. **阈值触发**

   * CPU/内存/磁盘超过阈值时才发送告警
   * 可设置多级阈值：警告、严重

2. **告警去重**

   * 避免同一指标重复发送
   * 可通过 Redis / 本地缓存记录上一次告警状态

3. **多渠道通知**

   * 飞书 + 邮件 + 钉钉 / Slack，多渠道确保通知到位

4. **日志记录**

   * 所有告警发送记录写入日志文件或数据库
   * 方便事后排查和统计

5. **消息格式清晰**

   * 时间、服务名、指标、当前值、阈值
   * 可添加链接到 Grafana / Prometheus Dashboard

---

我可以帮你写一个 **完整的 Python 告警通知模块模板**，支持：

* **Prometheus/SSH/本地 Shell** 指标判断
* **阈值超标自动发送飞书 + 邮件**
* **日志记录 + 告警去重**

几乎是生产级告警通知系统。

你希望我写这个模板吗？


明白了 ✅，下面给你一个 **生产级 Python 告警通知模块模板**，可以直接用于 SRE 监控系统。

特点：

* 支持 **Prometheus / SSH / 本地 Shell** 指标判断
* CPU / 内存 / 磁盘阈值超标自动告警
* **飞书 + 邮件** 双通道通知
* **日志记录 + 告警去重**

---

## 🧩 Python 告警通知模板

```python
import requests
import json
import smtplib
from email.mime.text import MIMEText
from datetime import datetime

# ==============================
# 配置区
# ==============================
FEISHU_WEBHOOK = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxx-xxxx-xxxx"

SMTP_SERVER = "smtp.example.com"
SMTP_PORT = 25
FROM_EMAIL = "monitor@example.com"
TO_EMAIL = "admin@example.com"

LOG_FILE = "alerts.log"

CPU_THRESHOLD = 80
MEM_THRESHOLD = 85
DISK_THRESHOLD = 90

# 告警去重缓存
alert_cache = {}

# ==============================
# 函数区
# ==============================
def log_alert(text):
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(text + "\n")
    print(text)

def send_feishu_alert(text):
    payload = {"msg_type": "text", "content": {"text": text}}
    headers = {"Content-Type": "application/json"}
    try:
        response = requests.post(FEISHU_WEBHOOK, headers=headers, data=json.dumps(payload), timeout=5)
        if response.status_code != 200:
            print(f"飞书发送失败: {response.text}")
    except Exception as e:
        print(f"飞书发送异常: {e}")

def send_email_alert(subject, content):
    msg = MIMEText(content, "plain", "utf-8")
    msg['Subject'] = subject
    msg['From'] = FROM_EMAIL
    msg['To'] = TO_EMAIL
    try:
        server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
        server.send_message(msg)
        server.quit()
        print("邮件告警已发送")
    except Exception as e:
        print(f"邮件发送失败: {e}")

def send_alert(service, metric, value, threshold):
    """统一发送告警，并支持去重"""
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    key = f"{service}_{metric}"
    
    # 去重：同一指标告警 30 分钟内不重复发送
    if key in alert_cache:
        last_time = alert_cache[key]
        if (datetime.now() - last_time).seconds < 1800:
            return
    alert_cache[key] = datetime.now()
    
    if value > threshold:
        text = f"[{now}] ⚠️ 服务 {service} {metric} 超过阈值！当前 {value}% (阈值 {threshold}%)"
        log_alert(text)
        send_feishu_alert(text)
        send_email_alert(f"{service} {metric} 告警", text)
    else:
        text = f"[{now}] ✅ 服务 {service} {metric} 正常，当前 {value}%"
        log_alert(text)

# ==============================
# 示例调用
# ==============================
if __name__ == "__main__":
    # 假设 Prometheus / SSH / Shell 获取的指标
    sample_metrics = {
        "payment": {"CPU": 88, "MEM": 65, "DISK": 70},
        "auth": {"CPU": 72, "MEM": 80, "DISK": 92},
        "monitoring": {"CPU": 65, "MEM": 60, "DISK": 50}
    }

    for service, metrics in sample_metrics.items():
        send_alert(service, "CPU", metrics["CPU"], CPU_THRESHOLD)
        send_alert(service, "MEM", metrics["MEM"], MEM_THRESHOLD)
        send_alert(service, "DISK", metrics["DISK"], DISK_THRESHOLD)

    print("告警检查完成 ✅")
```

---

### 🔹 模板特点

1. **统一告警函数**：`send_alert()` 支持任意指标
2. **去重机制**：30 分钟内同一指标不重复告警
3. **双通道通知**：飞书 + 邮件
4. **日志记录**：所有告警和正常信息写入 `alerts.log`
5. **可扩展性**：

   * 添加新的指标：如网络流量、服务状态
   * 调整阈值或告警频率
   * 可结合定时执行，实现无人值守巡检

---

如果你希望，我可以帮你整合 **完整生产级 SRE 自动化监控系统**：

* Prometheus API + SSH + 本地 Shell
* CPU / 内存 / 磁盘阈值告警
* 飞书 + 邮件通知
* 日志 + Excel 报表
* 定时巡检

几乎就是可直接投入生产的监控脚本。

你希望我写这个完整系统吗？
