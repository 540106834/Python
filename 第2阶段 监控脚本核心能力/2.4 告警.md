æ˜ç™½äº† âœ…ï¼Œæˆ‘ä»¬æŠŠé‡ç‚¹æ”¾åœ¨ **å‘é€å‘Šè­¦é€šçŸ¥**ï¼Œè¿™æ˜¯ SRE ç›‘æ§ä½“ç³»ä¸­æœ€å…³é”®çš„ä¸€ç¯ã€‚
å‘Šè­¦é€šçŸ¥çš„æ ¸å¿ƒç›®æ ‡æ˜¯ï¼š**å½“æŒ‡æ ‡è¶…è¿‡é˜ˆå€¼æ—¶ï¼Œç«‹å³é€šçŸ¥ç›¸å…³è´Ÿè´£äººæˆ–å›¢é˜Ÿ**ã€‚

---

## ğŸ§­ å‘Šè­¦é€šçŸ¥æ–¹å¼

| æ–¹å¼         | Python æŠ€æœ¯/åº“         | è¯´æ˜                     |
| ---------- | ------------------- | ---------------------- |
| é£ä¹¦æœºå™¨äºº      | `requests`          | æ”¯æŒæ–‡æœ¬ã€å¯Œæ–‡æœ¬æ¶ˆæ¯ï¼Œç›´æ¥æ¨é€åˆ°ç¾¤      |
| é‚®ä»¶         | `smtplib` + `email` | ä¼ ç»Ÿé‚®ä»¶å‘Šè­¦ï¼Œæ”¯æŒ HTML/é™„ä»¶      |
| Slack / é’‰é’‰ | `requests`          | ä¼ä¸šèŠå¤©å·¥å…·ï¼ŒHTTP Webhook æ¨é€ |
| ç³»ç»Ÿå‘Šè­¦       | `subprocess`        | è§¦å‘ç³»ç»Ÿé€šçŸ¥æˆ–æ—¥å¿—æŠ¥è­¦            |

---

## ğŸ”¹ é£ä¹¦å‘Šè­¦ç¤ºä¾‹ï¼ˆæœ€å¸¸ç”¨ï¼‰

```python
import requests
import json
from datetime import datetime

FEISHU_WEBHOOK = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxx-xxxx-xxxx"

def send_feishu_alert(service_name, metric, value, threshold):
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    if value > threshold:
        text = f"[{now}] âš ï¸ æœåŠ¡ {service_name} {metric} è¶…è¿‡é˜ˆå€¼ï¼å½“å‰ {value}%"
    else:
        text = f"[{now}] âœ… æœåŠ¡ {service_name} {metric} æ­£å¸¸ï¼Œå½“å‰ {value}%"

    payload = {"msg_type": "text", "content": {"text": text}}
    headers = {"Content-Type": "application/json"}

    try:
        response = requests.post(FEISHU_WEBHOOK, headers=headers, data=json.dumps(payload), timeout=5)
        if response.status_code != 200:
            print(f"é£ä¹¦å‘é€å¤±è´¥: {response.text}")
    except Exception as e:
        print(f"å‘é€å¼‚å¸¸: {e}")

# æµ‹è¯•
send_feishu_alert("payment", "CPU", 88, 80)
```

âœ… è¾“å‡ºç¤ºä¾‹ï¼ˆé£ä¹¦ç¾¤æ¶ˆæ¯ï¼‰ï¼š

```
[2025-10-26 09:30:00] âš ï¸ æœåŠ¡ payment CPU è¶…è¿‡é˜ˆå€¼ï¼å½“å‰ 88%
```

---

## ğŸ”¹ é‚®ä»¶å‘Šè­¦ç¤ºä¾‹

```python
import smtplib
from email.mime.text import MIMEText

SMTP_SERVER = "smtp.example.com"
SMTP_PORT = 25
FROM_EMAIL = "monitor@example.com"
TO_EMAIL = "admin@example.com"

def send_email_alert(subject, content):
    msg = MIMEText(content, "plain", "utf-8")
    msg['Subject'] = subject
    msg['From'] = FROM_EMAIL
    msg['To'] = TO_EMAIL

    try:
        server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
        server.send_message(msg)
        server.quit()
        print("é‚®ä»¶å‘Šè­¦å·²å‘é€")
    except Exception as e:
        print(f"é‚®ä»¶å‘é€å¤±è´¥: {e}")

# æµ‹è¯•
send_email_alert("CPU å‘Šè­¦", "æœåŠ¡ payment CPU è¶…è¿‡é˜ˆå€¼ï¼å½“å‰ 88%")
```

---

## ğŸ”¹ å‘Šè­¦å‘é€æœ€ä½³å®è·µ

1. **é˜ˆå€¼è§¦å‘**

   * CPU/å†…å­˜/ç£ç›˜è¶…è¿‡é˜ˆå€¼æ—¶æ‰å‘é€å‘Šè­¦
   * å¯è®¾ç½®å¤šçº§é˜ˆå€¼ï¼šè­¦å‘Šã€ä¸¥é‡

2. **å‘Šè­¦å»é‡**

   * é¿å…åŒä¸€æŒ‡æ ‡é‡å¤å‘é€
   * å¯é€šè¿‡ Redis / æœ¬åœ°ç¼“å­˜è®°å½•ä¸Šä¸€æ¬¡å‘Šè­¦çŠ¶æ€

3. **å¤šæ¸ é“é€šçŸ¥**

   * é£ä¹¦ + é‚®ä»¶ + é’‰é’‰ / Slackï¼Œå¤šæ¸ é“ç¡®ä¿é€šçŸ¥åˆ°ä½

4. **æ—¥å¿—è®°å½•**

   * æ‰€æœ‰å‘Šè­¦å‘é€è®°å½•å†™å…¥æ—¥å¿—æ–‡ä»¶æˆ–æ•°æ®åº“
   * æ–¹ä¾¿äº‹åæ’æŸ¥å’Œç»Ÿè®¡

5. **æ¶ˆæ¯æ ¼å¼æ¸…æ™°**

   * æ—¶é—´ã€æœåŠ¡åã€æŒ‡æ ‡ã€å½“å‰å€¼ã€é˜ˆå€¼
   * å¯æ·»åŠ é“¾æ¥åˆ° Grafana / Prometheus Dashboard

---

æˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ª **å®Œæ•´çš„ Python å‘Šè­¦é€šçŸ¥æ¨¡å—æ¨¡æ¿**ï¼Œæ”¯æŒï¼š

* **Prometheus/SSH/æœ¬åœ° Shell** æŒ‡æ ‡åˆ¤æ–­
* **é˜ˆå€¼è¶…æ ‡è‡ªåŠ¨å‘é€é£ä¹¦ + é‚®ä»¶**
* **æ—¥å¿—è®°å½• + å‘Šè­¦å»é‡**

å‡ ä¹æ˜¯ç”Ÿäº§çº§å‘Šè­¦é€šçŸ¥ç³»ç»Ÿã€‚

ä½ å¸Œæœ›æˆ‘å†™è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ


æ˜ç™½äº† âœ…ï¼Œä¸‹é¢ç»™ä½ ä¸€ä¸ª **ç”Ÿäº§çº§ Python å‘Šè­¦é€šçŸ¥æ¨¡å—æ¨¡æ¿**ï¼Œå¯ä»¥ç›´æ¥ç”¨äº SRE ç›‘æ§ç³»ç»Ÿã€‚

ç‰¹ç‚¹ï¼š

* æ”¯æŒ **Prometheus / SSH / æœ¬åœ° Shell** æŒ‡æ ‡åˆ¤æ–­
* CPU / å†…å­˜ / ç£ç›˜é˜ˆå€¼è¶…æ ‡è‡ªåŠ¨å‘Šè­¦
* **é£ä¹¦ + é‚®ä»¶** åŒé€šé“é€šçŸ¥
* **æ—¥å¿—è®°å½• + å‘Šè­¦å»é‡**

---

## ğŸ§© Python å‘Šè­¦é€šçŸ¥æ¨¡æ¿

```python
import requests
import json
import smtplib
from email.mime.text import MIMEText
from datetime import datetime

# ==============================
# é…ç½®åŒº
# ==============================
FEISHU_WEBHOOK = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxx-xxxx-xxxx"

SMTP_SERVER = "smtp.example.com"
SMTP_PORT = 25
FROM_EMAIL = "monitor@example.com"
TO_EMAIL = "admin@example.com"

LOG_FILE = "alerts.log"

CPU_THRESHOLD = 80
MEM_THRESHOLD = 85
DISK_THRESHOLD = 90

# å‘Šè­¦å»é‡ç¼“å­˜
alert_cache = {}

# ==============================
# å‡½æ•°åŒº
# ==============================
def log_alert(text):
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(text + "\n")
    print(text)

def send_feishu_alert(text):
    payload = {"msg_type": "text", "content": {"text": text}}
    headers = {"Content-Type": "application/json"}
    try:
        response = requests.post(FEISHU_WEBHOOK, headers=headers, data=json.dumps(payload), timeout=5)
        if response.status_code != 200:
            print(f"é£ä¹¦å‘é€å¤±è´¥: {response.text}")
    except Exception as e:
        print(f"é£ä¹¦å‘é€å¼‚å¸¸: {e}")

def send_email_alert(subject, content):
    msg = MIMEText(content, "plain", "utf-8")
    msg['Subject'] = subject
    msg['From'] = FROM_EMAIL
    msg['To'] = TO_EMAIL
    try:
        server = smtplib.SMTP(SMTP_SERVER, SMTP_PORT)
        server.send_message(msg)
        server.quit()
        print("é‚®ä»¶å‘Šè­¦å·²å‘é€")
    except Exception as e:
        print(f"é‚®ä»¶å‘é€å¤±è´¥: {e}")

def send_alert(service, metric, value, threshold):
    """ç»Ÿä¸€å‘é€å‘Šè­¦ï¼Œå¹¶æ”¯æŒå»é‡"""
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    key = f"{service}_{metric}"
    
    # å»é‡ï¼šåŒä¸€æŒ‡æ ‡å‘Šè­¦ 30 åˆ†é’Ÿå†…ä¸é‡å¤å‘é€
    if key in alert_cache:
        last_time = alert_cache[key]
        if (datetime.now() - last_time).seconds < 1800:
            return
    alert_cache[key] = datetime.now()
    
    if value > threshold:
        text = f"[{now}] âš ï¸ æœåŠ¡ {service} {metric} è¶…è¿‡é˜ˆå€¼ï¼å½“å‰ {value}% (é˜ˆå€¼ {threshold}%)"
        log_alert(text)
        send_feishu_alert(text)
        send_email_alert(f"{service} {metric} å‘Šè­¦", text)
    else:
        text = f"[{now}] âœ… æœåŠ¡ {service} {metric} æ­£å¸¸ï¼Œå½“å‰ {value}%"
        log_alert(text)

# ==============================
# ç¤ºä¾‹è°ƒç”¨
# ==============================
if __name__ == "__main__":
    # å‡è®¾ Prometheus / SSH / Shell è·å–çš„æŒ‡æ ‡
    sample_metrics = {
        "payment": {"CPU": 88, "MEM": 65, "DISK": 70},
        "auth": {"CPU": 72, "MEM": 80, "DISK": 92},
        "monitoring": {"CPU": 65, "MEM": 60, "DISK": 50}
    }

    for service, metrics in sample_metrics.items():
        send_alert(service, "CPU", metrics["CPU"], CPU_THRESHOLD)
        send_alert(service, "MEM", metrics["MEM"], MEM_THRESHOLD)
        send_alert(service, "DISK", metrics["DISK"], DISK_THRESHOLD)

    print("å‘Šè­¦æ£€æŸ¥å®Œæˆ âœ…")
```

---

### ğŸ”¹ æ¨¡æ¿ç‰¹ç‚¹

1. **ç»Ÿä¸€å‘Šè­¦å‡½æ•°**ï¼š`send_alert()` æ”¯æŒä»»æ„æŒ‡æ ‡
2. **å»é‡æœºåˆ¶**ï¼š30 åˆ†é’Ÿå†…åŒä¸€æŒ‡æ ‡ä¸é‡å¤å‘Šè­¦
3. **åŒé€šé“é€šçŸ¥**ï¼šé£ä¹¦ + é‚®ä»¶
4. **æ—¥å¿—è®°å½•**ï¼šæ‰€æœ‰å‘Šè­¦å’Œæ­£å¸¸ä¿¡æ¯å†™å…¥ `alerts.log`
5. **å¯æ‰©å±•æ€§**ï¼š

   * æ·»åŠ æ–°çš„æŒ‡æ ‡ï¼šå¦‚ç½‘ç»œæµé‡ã€æœåŠ¡çŠ¶æ€
   * è°ƒæ•´é˜ˆå€¼æˆ–å‘Šè­¦é¢‘ç‡
   * å¯ç»“åˆå®šæ—¶æ‰§è¡Œï¼Œå®ç°æ— äººå€¼å®ˆå·¡æ£€

---

å¦‚æœä½ å¸Œæœ›ï¼Œæˆ‘å¯ä»¥å¸®ä½ æ•´åˆ **å®Œæ•´ç”Ÿäº§çº§ SRE è‡ªåŠ¨åŒ–ç›‘æ§ç³»ç»Ÿ**ï¼š

* Prometheus API + SSH + æœ¬åœ° Shell
* CPU / å†…å­˜ / ç£ç›˜é˜ˆå€¼å‘Šè­¦
* é£ä¹¦ + é‚®ä»¶é€šçŸ¥
* æ—¥å¿— + Excel æŠ¥è¡¨
* å®šæ—¶å·¡æ£€

å‡ ä¹å°±æ˜¯å¯ç›´æ¥æŠ•å…¥ç”Ÿäº§çš„ç›‘æ§è„šæœ¬ã€‚

ä½ å¸Œæœ›æˆ‘å†™è¿™ä¸ªå®Œæ•´ç³»ç»Ÿå—ï¼Ÿ
