明白了 ✅，我们把重点放在 **SRE 监控的“数据解析”**上，这也是告警和报表的核心。
数据解析的目标是：**把从 Prometheus、SSH、或者本地 Shell 获取的原始数据，处理成可用指标，并判断是否触发告警**。

---

## 🧭 数据解析核心步骤

1. **获取原始数据**

   * Prometheus API → JSON
   * SSH 节点命令 → 字符串
   * 本地 Shell → 字符串

2. **提取关键指标**

   * CPU / 内存 / 磁盘使用率
   * 服务状态（active / inactive）
   * 自定义业务指标（如请求数、延迟）

3. **类型转换 & 数值化**

   * 字符串 → float / int
   * 去掉百分号 `%`
   * 错误或异常值处理（异常值置空或忽略）

4. **阈值判断**

   * CPU/内存/磁盘超阈值 → 告警
   * 可多级阈值：警告 / 严重 / 临界

5. **结构化数据存储**

   * 写入日志（文本或 JSON）
   * 写入报表（Excel / CSV）
   * 可存入数据库，便于查询和统计

---

## 🔹 Python 数据解析示例

### 1️⃣ Prometheus JSON 数据解析

```python
import json

# 假设 Prometheus API 返回 JSON
prometheus_response = {
    "status": "success",
    "data": {
        "resultType": "vector",
        "result": [
            {"metric": {"instance": "node1"}, "value": [1698312345, "72"]},
            {"metric": {"instance": "node2"}, "value": [1698312345, "88"]}
        ]
    }
}

# 提取指标
metrics = {}
for item in prometheus_response["data"]["result"]:
    instance = item["metric"]["instance"]
    value = float(item["value"][1])
    metrics[instance] = value

print(metrics)
# 输出: {'node1': 72.0, 'node2': 88.0}
```

---

### 2️⃣ SSH 或本地 Shell 字符串解析

```python
# CPU 使用率命令输出示例
ssh_output = "88.5"  # top 命令输出
cpu_usage = float(ssh_output.strip())
print(cpu_usage)  # 88.5

# 内存命令输出示例
mem_output = "65.2%"
mem_usage = float(mem_output.strip('%'))
print(mem_usage)  # 65.2
```

---

### 3️⃣ 阈值判断 & 告警触发

```python
CPU_THRESHOLD = 80
MEM_THRESHOLD = 85

def check_threshold(service, metric, value, threshold):
    if value > threshold:
        print(f"⚠️ {service} {metric} 超过阈值！当前 {value}%")
    else:
        print(f"✅ {service} {metric} 正常，当前 {value}%")

# 示例
check_threshold("payment", "CPU", cpu_usage, CPU_THRESHOLD)
check_threshold("payment", "MEM", mem_usage, MEM_THRESHOLD)
```

---

### 4️⃣ 结构化存储 & 日志

```python
from datetime import datetime

now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
log_text = f"[{now}] payment CPU={cpu_usage}%, MEM={mem_usage}%"
with open("monitor.log", "a", encoding="utf-8") as f:
    f.write(log_text + "\n")
```

---

### 🔹 数据解析最佳实践

1. **统一格式**

   * 所有指标解析后统一为 float 类型
   * 所有时间戳统一 ISO 格式

2. **异常处理**

   * Prometheus API 请求失败 → 返回空字典
   * SSH / Shell 输出异常 → 跳过并记录日志

3. **可扩展性**

   * 支持新指标类型（网络、服务状态、业务指标）
   * 支持多维度数据解析（多个节点、多种指标）

4. **与告警联动**

   * 数据解析完成后立即调用告警模块
   * 保证监控数据 -> 阈值判断 -> 告警通知流程完整

---

我可以帮你写一个 **生产级“数据解析 + 阈值判断 + 告警通知”完整 Python 模块**，可直接和 Prometheus API / SSH / Shell 集成，输出日志和报表，支持飞书和邮件告警。

你希望我写这个模块吗？
