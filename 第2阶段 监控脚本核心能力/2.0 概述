å¤ªå¥½äº† ğŸš€
æˆ‘ä»¬ç›´æ¥è¿›å…¥ **é˜¶æ®µ 2ï¼šç›‘æ§è„šæœ¬æ ¸å¿ƒèƒ½åŠ›ï¼ˆAPI / å‘Šè­¦ / SSHï¼‰**ï¼Œè¿™æ˜¯ SRE Python å®æˆ˜ä¸­éå¸¸å…³é”®çš„ä¸€éƒ¨åˆ†ã€‚
ç›®æ ‡æ˜¯è®©ä½ èƒ½**ç›´æ¥å†™å‡ºç›‘æ§æ•°æ®é‡‡é›†ã€å‘Šè­¦å¤„ç†ã€è¿œç¨‹å·¡æ£€**çš„è„šæœ¬ã€‚

---

## ğŸ§­ é˜¶æ®µ 2 æ ¸å¿ƒæ¨¡å—

| æ¨¡å—          | Python åº“               | SRE å®æˆ˜ç”¨é€”                                           |
| ----------- | ---------------------- | -------------------------------------------------- |
| HTTP API è°ƒç”¨ | `requests`             | è°ƒç”¨ Prometheus / Alertmanager / Grafana API è·å–æŒ‡æ ‡æˆ–å‘Šè­¦ |
| SSH è‡ªåŠ¨åŒ–     | `paramiko`             | æ‰¹é‡ç™»å½•èŠ‚ç‚¹æ‰§è¡Œå‘½ä»¤ï¼Œè·å–ç³»ç»Ÿä¿¡æ¯                                  |
| æœ¬åœ° Shell    | `subprocess`           | æ‰§è¡Œæœ¬åœ°è¿ç»´å‘½ä»¤ï¼ˆpingã€curlã€df ç­‰ï¼‰                           |
| é‚®ä»¶å‘Šè­¦        | `smtplib` / `email`    | å‘é€å‘Šè­¦é‚®ä»¶é€šçŸ¥                                           |
| æ•°æ®è§£æ        | `json` / `yaml` / `re` | å¤„ç† API è¿”å›æ•°æ®æˆ–æ—¥å¿—å†…å®¹                                   |

---

### 1ï¸âƒ£ Prometheus API æŸ¥è¯¢æŒ‡æ ‡

```python
import requests

# å‡è®¾ Prometheus API URL
url = "http://localhost:9090/api/v1/query"
query = {"query": "node_cpu_seconds_total"}

response = requests.get(url, params=query)
data = response.json()

# æ‰“å°éƒ¨åˆ†æ•°æ®
for result in data["data"]["result"][:5]:
    print(result["metric"], result["value"])
```

ğŸ’¡ è¯´æ˜ï¼š

* `requests.get(url, params=query)` å‘èµ· GET è¯·æ±‚
* `data["data"]["result"]` æ˜¯ Prometheus è¿”å›çš„æŒ‡æ ‡åˆ—è¡¨
* å¯è¿›ä¸€æ­¥å¤„ç†å¹¶å†™å…¥æ—¥å¿—æˆ–å‘Šè­¦ç³»ç»Ÿ

---

### 2ï¸âƒ£ Alertmanager API æŸ¥è¯¢å‘Šè­¦

```python
url = "http://localhost:9093/api/v1/alerts"
response = requests.get(url)
alerts = response.json()["data"]

for alert in alerts:
    print(f"{alert['labels']['alertname']} çŠ¶æ€: {alert['status']}")
```

* è·å–æ´»è·ƒå‘Šè­¦åˆ—è¡¨
* å¯ç»Ÿè®¡å‘Šè­¦æ•°é‡ã€æŒ‰ä¸šåŠ¡åˆ†ç±»ã€ç”Ÿæˆæ—¥æŠ¥

---

### 3ï¸âƒ£ SSH æ‰¹é‡æ‰§è¡Œå‘½ä»¤ï¼ˆParamikoï¼‰

```python
import paramiko

host = "192.168.1.100"
username = "user"
password = "pass"

ssh = paramiko.SSHClient()
ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
ssh.connect(host, username=username, password=password)

stdin, stdout, stderr = ssh.exec_command("uptime")
print(stdout.read().decode())

ssh.close()
```

ğŸ’¡ å¯æ‰¹é‡å¾ªç¯å¤šå°ä¸»æœºæ‰§è¡Œå‘½ä»¤ï¼Œæ¯”å¦‚ï¼š

* CPU / å†…å­˜ / ç£ç›˜å·¡æ£€
* æœåŠ¡çŠ¶æ€æ£€æŸ¥ï¼ˆsystemctl status xxxï¼‰

---

### 4ï¸âƒ£ å‘é€é‚®ä»¶å‘Šè­¦

```python
import smtplib
from email.mime.text import MIMEText

msg = MIMEText("CPU ä½¿ç”¨ç‡è¶…è¿‡é˜ˆå€¼ï¼")
msg['Subject'] = "ç›‘æ§å‘Šè­¦"
msg['From'] = "monitor@example.com"
msg['To'] = "admin@example.com"

server = smtplib.SMTP("smtp.example.com", 25)
server.send_message(msg)
server.quit()
```

ğŸ’¡ åœ¨å®é™… SRE åœºæ™¯ä¸­ï¼Œå¯ä»¥é…åˆè½®è¯¢æˆ– API æ£€æµ‹ï¼Œå®ç°è‡ªåŠ¨å‘Šè­¦ã€‚

---

### ğŸ”§ å°ç»ƒä¹ 

è¯·å†™ä¸€ä¸ªè„šæœ¬ï¼Œå®ç°ä»¥ä¸‹é€»è¾‘ï¼š

1. æ¨¡æ‹Ÿä» Prometheus API è·å–ä¸‰ä¸ªæœåŠ¡çš„ CPU ä½¿ç”¨ç‡ï¼š

```python
cpu_usages = {"auth": 72, "payment": 88, "monitoring": 65}
```

2. é˜ˆå€¼ä¸º 80ï¼Œè¶…è¿‡é˜ˆå€¼çš„æœåŠ¡ï¼Œæ‰“å°å‘Šè­¦ä¿¡æ¯
3. å°†ç»“æœå†™å…¥æœ¬åœ°æ—¥å¿—æ–‡ä»¶ `cpu_alert.log`ï¼Œæ ¼å¼ï¼š

```
[2025-10-26 09:00:00] payment: âš ï¸ CPU è¶…è¿‡é˜ˆå€¼ï¼å½“å‰ 88%
```

---

æ˜¯å¦å¸Œæœ›æˆ‘ç›´æ¥ç»™å‡º **ç»ƒä¹ å‚è€ƒç­”æ¡ˆ + è®²è§£**ï¼Œæˆ–è€…å…ˆå¸®ä½ å†™ä¸€ä¸ª **SRE å®æˆ˜æ¨¡æ¿è„šæœ¬**ï¼ˆæ•´åˆ API + SSH + å‘Šè­¦ï¼‰ï¼Ÿ
