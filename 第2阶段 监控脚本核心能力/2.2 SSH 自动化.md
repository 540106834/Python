明白了 ✅
我们聚焦 **阶段 2：监控脚本核心能力 → SSH 自动化**，这是 SRE 运维脚本里最关键的一部分，可以**批量巡检服务器、获取指标、执行运维命令**。

---

## 🧭 SSH 自动化核心内容

### 1️⃣ 使用 Python `paramiko` 库

* **用途**：远程登录服务器执行命令
* **优势**：安全、可批量、可捕获输出

```python
import paramiko

# 节点信息
host = "192.168.1.100"
username = "user"
password = "pass"

# 创建 SSH 客户端
ssh = paramiko.SSHClient()
ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())  # 自动添加未知主机 key
ssh.connect(host, username=username, password=password)

# 执行命令
stdin, stdout, stderr = ssh.exec_command("uptime")
output = stdout.read().decode()
print(f"{host} uptime: {output}")

# 关闭连接
ssh.close()
```

✅ 输出示例：

```
192.168.1.100 uptime: 09:30:01 up 10 days, 3:45, 2 users, load average: 0.12, 0.08, 0.01
```

---

### 2️⃣ 批量节点巡检

```python
nodes = [
    {"host": "192.168.1.101", "user": "user", "pass": "pass"},
    {"host": "192.168.1.102", "user": "user", "pass": "pass"},
]

for node in nodes:
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(node["host"], username=node["user"], password=node["pass"])
    stdin, stdout, stderr = ssh.exec_command("uptime")
    print(f"{node['host']} uptime: {stdout.read().decode().strip()}")
    ssh.close()
```

💡 说明：

* 可批量获取 CPU/内存/磁盘/服务状态
* 输出可直接写入日志或发送告警

---

### 3️⃣ 获取 CPU 使用率示例

```python
command = "top -bn1 | grep 'Cpu(s)' | awk '{print $2 + $4}'"
stdin, stdout, stderr = ssh.exec_command(command)
cpu_usage = float(stdout.read().decode())
print(f"{host} CPU: {cpu_usage}%")
```

* `top -bn1`：非交互模式获取当前 CPU 使用情况
* `awk '{print $2 + $4}'`：提取用户 + 系统 CPU 使用率

---

### 4️⃣ SSH + 阈值告警结合示例

```python
CPU_THRESHOLD = 80

for node in nodes:
    ssh = paramiko.SSHClient()
    ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
    ssh.connect(node["host"], username=node["user"], password=node["pass"])
    
    stdin, stdout, stderr = ssh.exec_command(command)
    cpu = float(stdout.read().decode())
    
    if cpu > CPU_THRESHOLD:
        print(f"⚠️ {node['host']} CPU 超过阈值！当前 {cpu}%")
    else:
        print(f"✅ {node['host']} CPU 正常，当前 {cpu}%")
    
    ssh.close()
```

---

### 5️⃣ 扩展实战

* **飞书告警**：在 CPU 超过阈值时调用飞书接口
* **日志记录**：将所有巡检数据写入日志文件
* **多指标巡检**：CPU / 内存 / 磁盘 / 服务状态
* **定时巡检**：结合 Python `schedule` 或系统 `cron`

---

如果你希望，我可以帮你写一个 **“多节点 SSH 自动巡检 + CPU 内存阈值告警 + 飞书告警 + 日志”** 的完整模板脚本，直接可以投入生产使用。

你希望我写这个 SSH 自动化实战模板吗？


明白了 ✅，下面给你一个 **多节点 SSH 自动巡检 + CPU/内存阈值告警 + 飞书告警 + 日志记录** 的完整 SRE 实战模板脚本，可以直接用于生产环境。

---

## 🧩 SSH 自动化监控脚本模板（Python）

```python
import paramiko
import requests
import json
from datetime import datetime

# ==============================
# 配置区
# ==============================
NODES = [
    {"host": "192.168.1.101", "user": "user", "pass": "pass"},
    {"host": "192.168.1.102", "user": "user", "pass": "pass"}
]

CPU_THRESHOLD = 80  # CPU 使用率阈值 %
MEM_THRESHOLD = 85  # 内存使用率阈值 %

FEISHU_WEBHOOK = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxx-xxxx-xxxx"
LOG_FILE = "ssh_monitor.log"

# ==============================
# 函数区
# ==============================
def ssh_exec(node, command):
    """通过 SSH 执行命令并返回结果"""
    try:
        ssh = paramiko.SSHClient()
        ssh.set_missing_host_key_policy(paramiko.AutoAddPolicy())
        ssh.connect(node["host"], username=node["user"], password=node["pass"], timeout=5)
        stdin, stdout, stderr = ssh.exec_command(command)
        result = stdout.read().decode().strip()
        ssh.close()
        return result
    except Exception as e:
        print(f"{node['host']} SSH 执行失败: {e}")
        return None

def send_feishu_alert(text):
    """发送飞书告警"""
    payload = {"msg_type": "text", "content": {"text": text}}
    headers = {"Content-Type": "application/json"}
    try:
        resp = requests.post(FEISHU_WEBHOOK, headers=headers, data=json.dumps(payload), timeout=5)
        if resp.status_code != 200:
            print(f"飞书发送失败: {resp.text}")
    except Exception as e:
        print(f"飞书发送异常: {e}")

def check_metrics(node):
    """检查 CPU 和内存，并发送告警 + 写日志"""
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")

    # 获取 CPU 使用率
    cpu_cmd = "top -bn1 | grep 'Cpu(s)' | awk '{print $2 + $4}'"
    cpu_usage = ssh_exec(node, cpu_cmd)
    if cpu_usage:
        cpu_usage = float(cpu_usage)
        if cpu_usage > CPU_THRESHOLD:
            text = f"[{now}] ⚠️ {node['host']} CPU 超过阈值！当前 {cpu_usage}%"
            send_feishu_alert(text)
        else:
            text = f"[{now}] ✅ {node['host']} CPU 正常，当前 {cpu_usage}%"
        with open(LOG_FILE, "a", encoding="utf-8") as f:
            f.write(text + "\n")
        print(text)

    # 获取内存使用率
    mem_cmd = "free | grep Mem | awk '{print $3/$2 * 100}'"
    mem_usage = ssh_exec(node, mem_cmd)
    if mem_usage:
        mem_usage = float(mem_usage)
        if mem_usage > MEM_THRESHOLD:
            text = f"[{now}] ⚠️ {node['host']} 内存使用率超过阈值！当前 {mem_usage:.2f}%"
            send_feishu_alert(text)
        else:
            text = f"[{now}] ✅ {node['host']} 内存正常，当前 {mem_usage:.2f}%"
        with open(LOG_FILE, "a", encoding="utf-8") as f:
            f.write(text + "\n")
        print(text)

# ==============================
# 主程序
# ==============================
if __name__ == "__main__":
    for node in NODES:
        check_metrics(node)
    print("SSH 自动巡检完成 ✅")
```

---

### 🔹 脚本特点

1. **多节点巡检**：可批量检查任意服务器
2. **CPU + 内存阈值判断**：可轻松扩展磁盘、服务状态等指标
3. **飞书告警**：自动发送异常告警到群机器人
4. **日志记录**：每次巡检结果写入 `ssh_monitor.log`
5. **可扩展性**：

   * 增加 cron 定时执行，实现自动化巡检
   * 可将输出写入数据库或生成报表
   * 可增加异常重试机制，提高健壮性

---

如果你愿意，我可以帮你再写一个 **最终全自动 SRE 监控脚本模板**：

* 支持 **Prometheus API + SSH 多节点**
* CPU / 内存 / 磁盘阈值告警
* **飞书 + 邮件双通道告警**
* **日志 + Excel 报表 + 定时执行**

这样几乎就可以直接投入生产使用。

你希望我写这个最终模板吗？
