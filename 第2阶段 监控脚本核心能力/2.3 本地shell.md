明白了 ✅，我们进入 **阶段 2：监控脚本核心能力 → 本地 Shell 自动化**。
这是 SRE 运维中非常常用的一种技能，可以 **直接在 Python 脚本中调用本地命令**，实现巡检、指标获取和告警。

---

## 🧭 Python 调用本地 Shell 基础

### 1️⃣ 使用 `subprocess` 模块

* **优势**：安全、可捕获输出、可处理错误
* **适用场景**：`ping`、`df`、`top`、`systemctl status` 等命令

```python
import subprocess

# 执行本地命令
result = subprocess.run(["ls", "-l"], capture_output=True, text=True)
print(result.stdout)
```

💡 说明：

* `capture_output=True` 捕获标准输出
* `text=True` 返回字符串（而不是 bytes）
* `result.stderr` 可获取错误信息

---

### 2️⃣ 获取 CPU 使用率示例（本地）

```python
cmd = "top -bn1 | grep 'Cpu(s)' | awk '{print $2 + $4}'"
result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
cpu_usage = float(result.stdout.strip())
print(f"本地 CPU 使用率: {cpu_usage}%")
```

* `shell=True` 表示命令以 Shell 方式执行
* `awk` 用于提取 CPU 用户 + 系统使用率

---

### 3️⃣ 检查磁盘使用率示例

```python
cmd = "df -h / | awk 'NR==2 {print $5}'"
result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
disk_usage = result.stdout.strip()
print(f"根目录磁盘使用率: {disk_usage}")
```

---

### 4️⃣ 阈值告警示例（本地 CPU）

```python
CPU_THRESHOLD = 80

cmd = "top -bn1 | grep 'Cpu(s)' | awk '{print $2 + $4}'"
result = subprocess.run(cmd, shell=True, capture_output=True, text=True)
cpu_usage = float(result.stdout.strip())

if cpu_usage > CPU_THRESHOLD:
    print(f"⚠️ 本地 CPU 超过阈值！当前 {cpu_usage}%")
else:
    print(f"✅ 本地 CPU 正常，当前 {cpu_usage}%")
```

---

### 5️⃣ 扩展实战

* **日志记录**：将输出写入文件
* **飞书告警**：超过阈值时调用飞书接口
* **定时巡检**：结合 `schedule` 或系统 `cron` 定时执行
* **多指标监控**：CPU、内存、磁盘、服务状态

---

如果你希望，我可以帮你写一个 **“本地 Shell 自动巡检 + CPU/内存/磁盘阈值告警 + 飞书告警 + 日志记录”** 的完整 Python 模板脚本，直接可用。

你希望我写这个本地 Shell 自动化模板吗？
