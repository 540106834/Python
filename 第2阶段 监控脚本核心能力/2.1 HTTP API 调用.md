æ˜ç™½äº† âœ…ï¼Œæˆ‘ä»¬èšç„¦ **é˜¶æ®µ 2ï¼šç›‘æ§è„šæœ¬æ ¸å¿ƒèƒ½åŠ› â†’ HTTP API è°ƒç”¨**ï¼Œè¿™æ˜¯ SRE Python è„šæœ¬ä¸­æœ€å¸¸ç”¨çš„ä¸€éƒ¨åˆ†ã€‚
ç›®æ ‡æ˜¯æ•™ä½ ç”¨ Python **è°ƒç”¨ç›‘æ§ç³»ç»Ÿ APIï¼ˆPrometheus / Alertmanager / Grafanaï¼‰è·å–æ•°æ®ã€å¤„ç†æ•°æ®ï¼Œå¹¶å¯ç»“åˆå‘Šè­¦ç³»ç»Ÿ**ã€‚

---

## ğŸ§­ HTTP API è°ƒç”¨åŸºç¡€

### 1ï¸âƒ£ Python åº“

* **`requests`**ï¼šPython æœ€å¸¸ç”¨çš„ HTTP å®¢æˆ·ç«¯åº“
* å¯é€‰ï¼š`json` è§£æè¿”å›æ•°æ®

```python
import requests
import json
```

---

### 2ï¸âƒ£ Prometheus æŸ¥è¯¢æŒ‡æ ‡ç¤ºä¾‹

å‡è®¾ Prometheus æœåŠ¡åœ¨æœ¬æœº `9090` ç«¯å£ï¼š

```python
url = "http://localhost:9090/api/v1/query"

# æŸ¥è¯¢èŠ‚ç‚¹ CPU ä½¿ç”¨ç‡
query = {"query": "node_cpu_seconds_total"}

response = requests.get(url, params=query)
data = response.json()  # è¿”å› JSON æ•°æ®

# æ‰“å°å‰5æ¡ç»“æœ
for item in data["data"]["result"][:5]:
    print(item["metric"], item["value"])
```

ğŸ’¡ è¯´æ˜ï¼š

* `params=query` ä¼šå°†å­—å…¸è½¬æ¢ä¸º URL æŸ¥è¯¢å‚æ•°
* `data["data"]["result"]` æ˜¯ Prometheus è¿”å›çš„æŒ‡æ ‡åˆ—è¡¨
* å¯è¿›ä¸€æ­¥å¤„ç†ï¼Œæ¯”å¦‚ï¼šè®¡ç®— CPU ä½¿ç”¨ç‡ã€åˆ¤æ–­é˜ˆå€¼ã€å‘é€å‘Šè­¦

---

### 3ï¸âƒ£ Alertmanager æŸ¥è¯¢æ´»è·ƒå‘Šè­¦

```python
url = "http://localhost:9093/api/v1/alerts"
response = requests.get(url)
alerts = response.json()["data"]

for alert in alerts:
    print(f"{alert['labels']['alertname']} çŠ¶æ€: {alert['status']}")
```

* è·å–å½“å‰æ´»è·ƒå‘Šè­¦åˆ—è¡¨
* å¯åšå‘Šè­¦ç»Ÿè®¡ã€åˆ†ç±»æ±‡æ€»ã€å‘é€é£ä¹¦/é‚®ä»¶é€šçŸ¥

---

### 4ï¸âƒ£ Grafana API è°ƒç”¨ç¤ºä¾‹

è·å–æŸä¸ª Dashboard ä¿¡æ¯ï¼ˆéœ€ Grafana Tokenï¼‰ï¼š

```python
url = "http://localhost:3000/api/dashboards/uid/abcd1234"
headers = {
    "Authorization": "Bearer <your_grafana_api_token>"
}
response = requests.get(url, headers=headers)
dashboard = response.json()
print(dashboard["dashboard"]["title"])
```

---

### ğŸ”§ å®æˆ˜å°ç»ƒä¹ 

è¯·ä½ å†™ä¸€ä¸ªè„šæœ¬ï¼Œæ¨¡æ‹Ÿä»¥ä¸‹é€»è¾‘ï¼š

1. æ¨¡æ‹Ÿ Prometheus API è¿”å›ä¸‰ä¸ªæœåŠ¡ CPU ä½¿ç”¨ç‡ï¼š

```python
api_data = {
    "auth": 72,
    "payment": 88,
    "monitoring": 65
}
```

2. é˜ˆå€¼ 80ï¼Œè¶…è¿‡é˜ˆå€¼æ‰“å°å‘Šè­¦ä¿¡æ¯ï¼š

```
âš ï¸ payment CPU è¶…è¿‡é˜ˆå€¼ï¼å½“å‰ 88%
âœ… auth CPU æ­£å¸¸ï¼Œå½“å‰ 72%
```

3. å¯é€‰ï¼šå°†ç»“æœå†™å…¥æ—¥å¿—æ–‡ä»¶ `cpu_alert.log`

---

æˆ‘å¯ä»¥ç›´æ¥å¸®ä½ å†™ **HTTP API è°ƒç”¨ + é˜ˆå€¼åˆ¤æ–­ + é£ä¹¦å‘Šè­¦** çš„ **å®Œæ•´ç¤ºä¾‹è„šæœ¬**ï¼Œè®©ä½ å¯ç›´æ¥è¿è¡Œã€‚
ä½ å¸Œæœ›æˆ‘ç›´æ¥å†™è¿™ä¸ªå®æˆ˜æ¨¡æ¿å—ï¼Ÿ


å¤ªå¥½äº† ğŸš€
ä¸‹é¢ç»™ä½ ä¸€ä¸ª **SRE å®æˆ˜æ¨¡æ¿è„šæœ¬**ï¼Œæ•´åˆäº†ï¼š

* Prometheus API è·å–æŒ‡æ ‡
* CPU é˜ˆå€¼åˆ¤æ–­
* é£ä¹¦å‘Šè­¦å‘é€
* æ—¥å¿—è®°å½•

å¯ä»¥ç›´æ¥ç”¨äºç›‘æ§è‡ªåŠ¨åŒ–ã€‚

---

## ğŸ§© Python SRE é£ä¹¦å‘Šè­¦æ¨¡æ¿

```python
import requests
import json
from datetime import datetime

# ==============================
# é…ç½®åŒº
# ==============================
PROMETHEUS_URL = "http://localhost:9090/api/v1/query"
QUERY = {"query": "node_cpu_seconds_total"}  # ç¤ºä¾‹ Prometheus æŸ¥è¯¢
CPU_THRESHOLD = 80  # CPU ä½¿ç”¨ç‡é˜ˆå€¼
FEISHU_WEBHOOK = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxx-xxxx-xxxx"
LOG_FILE = "cpu_alert.log"

# ==============================
# å‡½æ•°åŒº
# ==============================
def fetch_cpu_metrics():
    """ä» Prometheus è·å– CPU ä½¿ç”¨ç‡æŒ‡æ ‡"""
    try:
        response = requests.get(PROMETHEUS_URL, params=QUERY, timeout=5)
        data = response.json()
        # æ¨¡æ‹Ÿå¤„ç†ï¼šè¿™é‡Œåªå–å‰ä¸‰ä¸ªæœåŠ¡ç¤ºä¾‹
        cpu_metrics = {}
        for item in data["data"]["result"][:3]:
            service_name = item["metric"].get("instance", "unknown")
            # value[1] æ˜¯æŒ‡æ ‡å€¼ï¼Œè½¬æˆ float
            cpu_metrics[service_name] = float(item["value"][1])
        return cpu_metrics
    except Exception as e:
        print(f"è·å– CPU æŒ‡æ ‡å¤±è´¥: {e}")
        return {}

def check_cpu_and_alert(service_name, cpu_usage, threshold):
    """æ£€æŸ¥ CPU å¹¶å‘é€é£ä¹¦å‘Šè­¦"""
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    if cpu_usage > threshold:
        text = f"[{now}] âš ï¸ æœåŠ¡ {service_name} CPU è¶…è¿‡é˜ˆå€¼ï¼å½“å‰ {cpu_usage:.2f}%"
    else:
        text = f"[{now}] âœ… æœåŠ¡ {service_name} CPU æ­£å¸¸ï¼Œå½“å‰ {cpu_usage:.2f}%"

    # å†™æ—¥å¿—
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(text + "\n")

    # å‘é€é£ä¹¦å‘Šè­¦
    payload = {"msg_type": "text", "content": {"text": text}}
    headers = {"Content-Type": "application/json"}
    try:
        resp = requests.post(FEISHU_WEBHOOK, headers=headers, data=json.dumps(payload), timeout=5)
        if resp.status_code != 200:
            print(f"é£ä¹¦å‘é€å¤±è´¥: {resp.text}")
    except Exception as e:
        print(f"é£ä¹¦å‘é€å¼‚å¸¸: {e}")

# ==============================
# ä¸»ç¨‹åº
# ==============================
if __name__ == "__main__":
    # ç¤ºä¾‹ï¼šå®é™…ä¸­å¯ç”¨ fetch_cpu_metrics() æ›¿ä»£ api_data
    # api_data = fetch_cpu_metrics()
    # æ¨¡æ‹Ÿ Prometheus API æ•°æ®
    api_data = {
        "auth": 72,
        "payment": 88,
        "monitoring": 65
    }

    for svc, usage in api_data.items():
        check_cpu_and_alert(svc, usage, CPU_THRESHOLD)

    print("å·¡æ£€å®Œæˆ âœ…")
```

---

### ğŸ”¹ è„šæœ¬ç‰¹ç‚¹

1. **HTTP API è°ƒç”¨**
   å¯æ›¿æ¢ä¸ºçœŸå® Prometheus æˆ–å…¶ä»–ç›‘æ§ç³»ç»Ÿ API

2. **CPU é˜ˆå€¼åˆ¤æ–­**
   `CPU_THRESHOLD` å¯æ ¹æ®ä¸šåŠ¡è°ƒæ•´

3. **é£ä¹¦å‘Šè­¦**
   æ”¯æŒå¼‚å¸¸ CPU è‡ªåŠ¨æ¨é€åˆ°ç¾¤æœºå™¨äºº

4. **æ—¥å¿—è®°å½•**
   æ¯æ¬¡å‘Šè­¦éƒ½ä¼šå†™å…¥ `cpu_alert.log`ï¼Œæ–¹ä¾¿åç»­ç»Ÿè®¡æˆ–è¿½è¸ª

5. **å¯æ‰©å±•**

   * å¢åŠ æ›´å¤šæŒ‡æ ‡ï¼ˆå†…å­˜ã€ç£ç›˜ï¼‰
   * å¢åŠ èŠ‚ç‚¹å·¡æ£€ï¼ˆSSH æ‰¹é‡æ‰§è¡Œå‘½ä»¤ï¼‰
   * å®šæ—¶æ‰§è¡Œï¼ˆç»“åˆ `schedule` æˆ– `cron`ï¼‰

---

æˆ‘å¯ä»¥å¸®ä½ ä¸‹ä¸€æ­¥å†™ **å‡çº§ç‰ˆ SRE è„šæœ¬**ï¼ŒåŒæ—¶æ”¯æŒï¼š

* Prometheus API çœŸå®æŒ‡æ ‡
* å¤šèŠ‚ç‚¹å·¡æ£€ï¼ˆSSH è·å– CPUï¼‰
* é£ä¹¦å‘Šè­¦
* æ—¥å¿— + Excel æŠ¥è¡¨

è¿™æ ·å°±æ¥è¿‘ç”Ÿäº§çº§ SRE è‡ªåŠ¨åŒ–è„šæœ¬ã€‚

ä½ å¸Œæœ›æˆ‘å†™è¿™ä¸ªå‡çº§ç‰ˆå—ï¼Ÿ


