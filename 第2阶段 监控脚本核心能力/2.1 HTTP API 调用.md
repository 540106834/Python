明白了 ✅，我们聚焦 **阶段 2：监控脚本核心能力 → HTTP API 调用**，这是 SRE Python 脚本中最常用的一部分。
目标是教你用 Python **调用监控系统 API（Prometheus / Alertmanager / Grafana）获取数据、处理数据，并可结合告警系统**。

---

## 🧭 HTTP API 调用基础

### 1️⃣ Python 库

* **`requests`**：Python 最常用的 HTTP 客户端库
* 可选：`json` 解析返回数据

```python
import requests
import json
```

---

### 2️⃣ Prometheus 查询指标示例

假设 Prometheus 服务在本机 `9090` 端口：

```python
url = "http://localhost:9090/api/v1/query"

# 查询节点 CPU 使用率
query = {"query": "node_cpu_seconds_total"}

response = requests.get(url, params=query)
data = response.json()  # 返回 JSON 数据

# 打印前5条结果
for item in data["data"]["result"][:5]:
    print(item["metric"], item["value"])
```

💡 说明：

* `params=query` 会将字典转换为 URL 查询参数
* `data["data"]["result"]` 是 Prometheus 返回的指标列表
* 可进一步处理，比如：计算 CPU 使用率、判断阈值、发送告警

---

### 3️⃣ Alertmanager 查询活跃告警

```python
url = "http://localhost:9093/api/v1/alerts"
response = requests.get(url)
alerts = response.json()["data"]

for alert in alerts:
    print(f"{alert['labels']['alertname']} 状态: {alert['status']}")
```

* 获取当前活跃告警列表
* 可做告警统计、分类汇总、发送飞书/邮件通知

---

### 4️⃣ Grafana API 调用示例

获取某个 Dashboard 信息（需 Grafana Token）：

```python
url = "http://localhost:3000/api/dashboards/uid/abcd1234"
headers = {
    "Authorization": "Bearer <your_grafana_api_token>"
}
response = requests.get(url, headers=headers)
dashboard = response.json()
print(dashboard["dashboard"]["title"])
```

---

### 🔧 实战小练习

请你写一个脚本，模拟以下逻辑：

1. 模拟 Prometheus API 返回三个服务 CPU 使用率：

```python
api_data = {
    "auth": 72,
    "payment": 88,
    "monitoring": 65
}
```

2. 阈值 80，超过阈值打印告警信息：

```
⚠️ payment CPU 超过阈值！当前 88%
✅ auth CPU 正常，当前 72%
```

3. 可选：将结果写入日志文件 `cpu_alert.log`

---

我可以直接帮你写 **HTTP API 调用 + 阈值判断 + 飞书告警** 的 **完整示例脚本**，让你可直接运行。
你希望我直接写这个实战模板吗？


太好了 🚀
下面给你一个 **SRE 实战模板脚本**，整合了：

* Prometheus API 获取指标
* CPU 阈值判断
* 飞书告警发送
* 日志记录

可以直接用于监控自动化。

---

## 🧩 Python SRE 飞书告警模板

```python
import requests
import json
from datetime import datetime

# ==============================
# 配置区
# ==============================
PROMETHEUS_URL = "http://localhost:9090/api/v1/query"
QUERY = {"query": "node_cpu_seconds_total"}  # 示例 Prometheus 查询
CPU_THRESHOLD = 80  # CPU 使用率阈值
FEISHU_WEBHOOK = "https://open.feishu.cn/open-apis/bot/v2/hook/xxxx-xxxx-xxxx"
LOG_FILE = "cpu_alert.log"

# ==============================
# 函数区
# ==============================
def fetch_cpu_metrics():
    """从 Prometheus 获取 CPU 使用率指标"""
    try:
        response = requests.get(PROMETHEUS_URL, params=QUERY, timeout=5)
        data = response.json()
        # 模拟处理：这里只取前三个服务示例
        cpu_metrics = {}
        for item in data["data"]["result"][:3]:
            service_name = item["metric"].get("instance", "unknown")
            # value[1] 是指标值，转成 float
            cpu_metrics[service_name] = float(item["value"][1])
        return cpu_metrics
    except Exception as e:
        print(f"获取 CPU 指标失败: {e}")
        return {}

def check_cpu_and_alert(service_name, cpu_usage, threshold):
    """检查 CPU 并发送飞书告警"""
    now = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
    if cpu_usage > threshold:
        text = f"[{now}] ⚠️ 服务 {service_name} CPU 超过阈值！当前 {cpu_usage:.2f}%"
    else:
        text = f"[{now}] ✅ 服务 {service_name} CPU 正常，当前 {cpu_usage:.2f}%"

    # 写日志
    with open(LOG_FILE, "a", encoding="utf-8") as f:
        f.write(text + "\n")

    # 发送飞书告警
    payload = {"msg_type": "text", "content": {"text": text}}
    headers = {"Content-Type": "application/json"}
    try:
        resp = requests.post(FEISHU_WEBHOOK, headers=headers, data=json.dumps(payload), timeout=5)
        if resp.status_code != 200:
            print(f"飞书发送失败: {resp.text}")
    except Exception as e:
        print(f"飞书发送异常: {e}")

# ==============================
# 主程序
# ==============================
if __name__ == "__main__":
    # 示例：实际中可用 fetch_cpu_metrics() 替代 api_data
    # api_data = fetch_cpu_metrics()
    # 模拟 Prometheus API 数据
    api_data = {
        "auth": 72,
        "payment": 88,
        "monitoring": 65
    }

    for svc, usage in api_data.items():
        check_cpu_and_alert(svc, usage, CPU_THRESHOLD)

    print("巡检完成 ✅")
```

---

### 🔹 脚本特点

1. **HTTP API 调用**
   可替换为真实 Prometheus 或其他监控系统 API

2. **CPU 阈值判断**
   `CPU_THRESHOLD` 可根据业务调整

3. **飞书告警**
   支持异常 CPU 自动推送到群机器人

4. **日志记录**
   每次告警都会写入 `cpu_alert.log`，方便后续统计或追踪

5. **可扩展**

   * 增加更多指标（内存、磁盘）
   * 增加节点巡检（SSH 批量执行命令）
   * 定时执行（结合 `schedule` 或 `cron`）

---

我可以帮你下一步写 **升级版 SRE 脚本**，同时支持：

* Prometheus API 真实指标
* 多节点巡检（SSH 获取 CPU）
* 飞书告警
* 日志 + Excel 报表

这样就接近生产级 SRE 自动化脚本。

你希望我写这个升级版吗？


