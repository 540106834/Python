好，现在你已经能把 **FastAPI + uvicorn** 跑起来了，我们就开始把配置“**从能跑 → 跑得稳 → 跑得像生产环境**”一步步完善。
我会用**完全小白视角**，不讲套话，全部落到**可直接用的配置**。

---

# 一、目标：我们要做到什么？

最终效果：

* 用 **systemd** 托管服务 ✅
* 开机自启 ✅
* 异常自动重启 ✅
* 指定虚拟环境 ✅
* 日志可查 ✅
* 安全监听端口 ✅
* 可优雅停止 ✅

---

---

# 二、推荐的目录结构

假设你的项目目录是：

```text
/data/pyweb/
 ├── main.py          # FastAPI入口
 ├── venv/            # 虚拟环境
 └── logs/            # 日志目录
```

---

创建日志目录：

```bash
mkdir -p /data/pyweb/logs
```

---

---

# 三、最推荐的 uvicorn 启动方式（生产可用）

---

**不要直接裸跑 uvicorn**

✅ 用结构化配置：

```bash
/data/pyweb/venv/bin/uvicorn main:app \
  --host 0.0.0.0 \
  --port 8000 \
  --workers 4 \
  --log-level info
```

---

## 参数人话解释

| 参数                 | 意义                |
| ------------------ | ----------------- |
| `main:app`         | main.py 里的 app 对象 |
| `--host 0.0.0.0`   | 对外网卡监听            |
| `--port 8000`      | 服务端口              |
| `--workers 4`      | 开4个进程处理并发         |
| `--log-level info` | 打开业务日志            |

---

---

# 四、systemd 标准服务配置

---

创建 service 文件：

```bash
sudo nano /etc/systemd/system/pyweb.service
```

---

粘贴：

```ini
[Unit]
Description=FastAPI Web Service
After=network.target

[Service]
User=root
WorkingDirectory=/data/pyweb

ExecStart=/data/pyweb/venv/bin/uvicorn main:app \
  --host 0.0.0.0 \
  --port 8000 \
  --workers 4 \
  --log-level info

Restart=always
RestartSec=3

StandardOutput=append:/data/pyweb/logs/stdout.log
StandardError=append:/data/pyweb/logs/error.log

LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
```

---

---

## 每一行人话解释 ✅

---

### 1️⃣ Service 属于谁运行

```ini
User=root
```

* 用 root 跑（测试OK）
* 生产推荐改普通用户

---

---

### 2️⃣ 工作目录

```ini
WorkingDirectory=/data/pyweb
```

* 相当于：

```bash
cd /data/pyweb
```

---

---

### 3️⃣ 启动命令

```ini
ExecStart=/data/pyweb/venv/bin/uvicorn main:app ...
```

* 指定**虚拟环境中的 uvicorn**
* 不用 source activate

---

---

### 4️⃣ 崩了重启

```ini
Restart=always
RestartSec=3
```

---

---

### 5️⃣ 日志输出

```ini
StandardOutput=append:/data/pyweb/logs/stdout.log
StandardError=append:/data/pyweb/logs/error.log
```

---

📂 日志路径：

```text
/data/pyweb/logs/stdout.log
/data/pyweb/logs/error.log
```

---

---

---

---

# 五、加载并启动服务

---

```bash
sudo systemctl daemon-reload

sudo systemctl start pyweb

sudo systemctl status pyweb -l
```

---

---

## 设置开机启动

```bash
sudo systemctl enable pyweb
```

---

---

---

# 六、核心运维命令速查

---

## ✅ 查看状态

```bash
systemctl status pyweb
```

---

## ✅ 实时查看日志

```bash
journalctl -u pyweb -f
```

---

## ✅ 查看业务输出日志

```bash
tail -f /data/pyweb/logs/stdout.log
```

---

## ✅ 重启

```bash
systemctl restart pyweb
```

---

## ✅ 停止

```bash
systemctl stop pyweb
```

---

---

---

# 七、安全增强配置（推荐）

---

### ✅ 减少暴露接口

如果不是公网访问：

```bash
--host 127.0.0.1
```

再用 Nginx 反代。

---

---

### ✅ nginx 代理示例

```nginx
server {
    listen 80;

    location / {
        proxy_pass http://127.0.0.1:8000;
        proxy_set_header Host $host;
    }
}
```

---

---

---

---

# 八、极简生产级完整方案（最终版）

---

```ini
[Unit]
Description=FastAPI Production Service
After=network.target

[Service]
User=www
WorkingDirectory=/data/pyweb
ExecStart=/data/pyweb/venv/bin/uvicorn main:app --host 127.0.0.1 --port 8000 --workers 4
Restart=always
RestartSec=3
LimitNOFILE=65535

[Install]
WantedBy=multi-user.target
```

---

**前端**：Nginx
**AI / 业务**：FastAPI
**进程守护**：systemd

---

---

---

---

# 九、你现在已经掌握了什么？

✅ 会自己修复 venv
✅ 会启动 uvicorn
✅ 看懂每个参数含义
✅ 会用 systemd 托管服务
✅ 会排查和查看日志

---

---

---

---

# 十、如果你想再进一步

可以学习的提升方向：

---

### 🔹 性能增强

* gunicorn + uvicorn worker
* uvloop
* keep-alive tuning
* async I/O 优化

---

### 🔹 高可用

* 多实例 + nginx upstream
* Docker or k8s 部署

---

### 🔹 安全

* HTTPS (Certbot)
* OAuth2 认证
* 请求限流

---

---

---

---

# 十一、非常重要的一句话

> 到现在为止
> 你已经不是“啥也不懂的小白了”
>
> ✅ **你已经能独立搭一个正规 Linux Web 服务**

---

---

---

---

## 下一步你可以选一个方向继续学：

| 你想学啥              | 我可以继续带你 |
| ----------------- | ------- |
| FastAPI 路由设计      | ✅       |
| 接数据库(MySQL/Redis) | ✅       |
| Nginx 反代 + HTTPS  | ✅       |
| Gunicorn 高并发部署    | ✅       |
| Docker 部署         | ✅       |
| 日志监控 Prometheus   | ✅       |

---

告诉我你现在最想补哪一块？我可以直接给你实战教程。
