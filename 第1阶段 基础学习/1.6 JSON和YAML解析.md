明白了，我们可以先在 **阶段 1 的延伸内容** 中讲解 **JSON / YAML 解析**，这是 SRE 脚本中非常重要的技能，用于读取配置文件、调用 API 或处理监控指标。

---

## 🧩 JSON / YAML 解析（SRE 实战版）

在运维场景中，你经常会遇到：

* Prometheus / Grafana API 返回 JSON 数据
* 配置文件使用 JSON 或 YAML 格式
* 日志或监控工具导出指标

Python 提供了 **`json`** 和 **`yaml`** 模块来解析和操作这些数据。

---

### 1️⃣ JSON 解析

#### 示例 JSON 数据（API 返回）：

```python
json_data = '''
{
    "services": [
        {"name": "auth", "status": 200},
        {"name": "payment", "status": 503},
        {"name": "monitoring", "status": 200}
    ]
}
'''
```

#### Python 解析示例：

```python
import json

# 解析 JSON 字符串
data = json.loads(json_data)

# 遍历服务状态
for svc in data["services"]:
    name = svc["name"]
    status = svc["status"]
    if status == 200:
        print(f"{name}: ✅ 正常")
    else:
        print(f"{name}: ⚠️ 异常 (status={status})")
```

💡 输出：

```
auth: ✅ 正常
payment: ⚠️ 异常 (status=503)
monitoring: ✅ 正常
```

---

### 2️⃣ YAML 解析

#### 示例 YAML 配置文件（`config.yaml`）：

```yaml
thresholds:
  cpu: 80
  memory: 85

services:
  - auth
  - payment
  - monitoring
```

#### Python 解析示例：

```python
import yaml

# 读取 YAML 文件
with open("config.yaml", "r", encoding="utf-8") as f:
    config = yaml.safe_load(f)

print("CPU 阈值:", config["thresholds"]["cpu"])
print("服务列表:", config["services"])
```

💡 输出：

```
CPU 阈值: 80
服务列表: ['auth', 'payment', 'monitoring']
```

---

### 3️⃣ 小练习

请你写一个脚本：

1. 读取 `config.yaml` 中 CPU 阈值和服务列表
2. 随机生成每个服务的 CPU 使用率（如 50~100%）
3. 判断是否超过阈值，并打印结果

输出示例：

```
auth: CPU 72% - ✅ 正常
payment: CPU 85% - ⚠️ 超过阈值
monitoring: CPU 60% - ✅ 正常
```

---

是否希望我接下来：
A. 给出练习答案 + 讲解
B. 继续讲解更高级的 JSON / YAML 结合 API 的实战使用


好的 👍 我们完成 **JSON / YAML 配置解析 + CPU 检测练习**，并讲解 SRE 实战用法。

---

## 🧩 练习题

**要求：**

1. 读取 `config.yaml`，获取：

   * CPU 阈值
   * 服务列表
2. 随机生成每个服务的 CPU 使用率（50~100%）
3. 判断是否超过阈值，并打印结果

输出示例：

```
auth: CPU 72% - ✅ 正常
payment: CPU 85% - ⚠️ 超过阈值
monitoring: CPU 60% - ✅ 正常
```

---

### ✅ 参考答案

```python
import yaml
import random

# 读取 YAML 配置
with open("config.yaml", "r", encoding="utf-8") as f:
    config = yaml.safe_load(f)

cpu_threshold = config["thresholds"]["cpu"]
services = config["services"]

# 定义 CPU 检测函数
def check_cpu(usage, threshold):
    if usage > threshold:
        return f"CPU {usage}% - ⚠️ 超过阈值"
    else:
        return f"CPU {usage}% - ✅ 正常"

# 随机生成 CPU 使用率并检测
for svc in services:
    usage = random.randint(50, 100)
    result = check_cpu(usage, cpu_threshold)
    print(f"{svc}: {result}")
```

---

### 💡 输出示例（每次随机不同）

```
auth: CPU 72% - ✅ 正常
payment: CPU 85% - ⚠️ 超过阈值
monitoring: CPU 60% - ✅ 正常
```

---

### 🧠 知识点讲解

| 知识点                      | 说明           | SRE 实战意义                         |
| ------------------------ | ------------ | -------------------------------- |
| `yaml.safe_load()`       | 读取 YAML 配置文件 | 安全解析配置，避免执行恶意代码                  |
| `random.randint(50,100)` | 模拟监控指标       | 可用于测试或生成示例数据                     |
| 函数封装                     | `check_cpu`  | 统一处理逻辑，方便复用                      |
| 结合配置文件                   | CPU 阈值、服务列表  | 实战中常通过 YAML/JSON 配置控制监控行为，无需改动脚本 |

---

### 🔧 进阶思路

1. 可以把 **CPU 使用率改为 API 获取的真实指标**：

```python
import requests
cpu = requests.get(f"http://monitoring/api/{svc}/cpu").json()["usage"]
```

2. 将检测结果写入日志文件：

```python
with open("cpu_monitor.log", "a") as f:
    f.write(f"{svc}: {result}\n")
```

3. 配合异常处理，保证配置缺失或 API 异常不会中断脚本。

---

接下来可以讲解 **命令行参数与自动化脚本**，让监控脚本可以更灵活地接收阈值或服务列表运行。

你希望我继续讲吗？


好的 🚀 我们进入 **JSON / YAML + API 实战使用**，这是 SRE 脚本中非常核心的能力。

---

## 🧩 高级实战：结合 API 读取 JSON/YAML 配置 + 动态指标监控

在实际运维场景中：

1. **配置文件（YAML/JSON）** 存放阈值、服务列表
2. **API（JSON）** 提供实时监控数据，如 CPU、内存、服务状态
3. 脚本需要动态读取配置并判断指标，生成告警

---

### 1️⃣ 示例场景

* YAML 配置文件 `config.yaml`：

```yaml
thresholds:
  cpu: 80
  memory: 85

services:
  - auth
  - payment
  - monitoring
```

* 模拟 API 返回 JSON 数据：

```json
{
  "auth": {"cpu": 72, "memory": 60},
  "payment": {"cpu": 88, "memory": 70},
  "monitoring": {"cpu": 65, "memory": 50}
}
```

---

### 2️⃣ Python 脚本实现

```python
import yaml
import requests

# 1. 读取 YAML 配置
with open("config.yaml", "r", encoding="utf-8") as f:
    config = yaml.safe_load(f)

cpu_threshold = config["thresholds"]["cpu"]
memory_threshold = config["thresholds"]["memory"]
services = config["services"]

# 2. 定义检测函数
def check_metric(service, metric_name, value, threshold):
    if value > threshold:
        return f"{service} {metric_name}: ⚠️ 超过阈值 ({value} > {threshold})"
    else:
        return f"{service} {metric_name}: ✅ 正常 ({value} <= {threshold})"

# 3. 获取 API 数据（这里用模拟数据代替 requests.get）
api_data = {
    "auth": {"cpu": 72, "memory": 60},
    "payment": {"cpu": 88, "memory": 70},
    "monitoring": {"cpu": 65, "memory": 50}
}

# 4. 遍历服务检测指标
for svc in services:
    data = api_data.get(svc, {})
    cpu_result = check_metric(svc, "CPU", data.get("cpu", 0), cpu_threshold)
    memory_result = check_metric(svc, "Memory", data.get("memory", 0), memory_threshold)
    print(cpu_result)
    print(memory_result)
```

---

### 💡 输出示例

```
auth CPU: ✅ 正常 (72 <= 80)
auth Memory: ✅ 正常 (60 <= 85)
payment CPU: ⚠️ 超过阈值 (88 > 80)
payment Memory: ✅ 正常 (70 <= 85)
monitoring CPU: ✅ 正常 (65 <= 80)
monitoring Memory: ✅ 正常 (50 <= 85)
```

---

### 3️⃣ 实战亮点

| 技术点          | 说明             | SRE 实战意义        |
| ------------ | -------------- | --------------- |
| YAML 配置      | 管理阈值和服务列表      | 配置集中管理，脚本无需修改   |
| API 数据（JSON） | 实时指标获取         | 支持动态监控多个服务或节点   |
| 函数封装         | `check_metric` | 统一处理逻辑，可扩展到更多指标 |
| 异常处理可加       | `try/except`   | 避免 API 异常中断监控脚本 |
| 扩展性          | 可写入日志或推送告警     | 自动化监控告警系统核心     |

---

### 🔧 进阶思路

1. **真实 API 获取数据**：

```python
import requests
resp = requests.get(f"http://monitoring/api/{svc}/metrics").json()
cpu = resp["cpu"]
memory = resp["memory"]
```

2. **异常保护**：

```python
try:
    data = requests.get(url, timeout=5).json()
except requests.exceptions.RequestException as e:
    print(f"{svc} API异常: {e}")
    continue
```

3. **日志 + 告警**：

* 将检测结果写入日志文件
* 超过阈值时通过邮件 / Slack / 飞书发送告警

---

如果你希望，我可以帮你整理一个 **完整的 SRE CPU/Memory 监控脚本模板**，
集 **YAML 配置、API 数据、阈值判断、日志写入、异常处理、告警输出** 于一体，可直接实战使用。

你希望我直接帮你整理吗？
