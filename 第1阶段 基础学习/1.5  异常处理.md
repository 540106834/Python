太好了 🚀
我们进入 **阶段 1 - 第 5 节：异常处理 + 错误保护脚本**

---

## 🧩 第 5 节：异常处理（try / except / finally）

在 SRE 场景中，监控脚本**必须稳定运行**，不能因为一次错误就中断整个监控流程。
Python 提供了 **异常处理机制** 来保证脚本健壮性。

---

### 1️⃣ 基本语法

```python
try:
    # 可能发生错误的代码
    result = 10 / 0
except ZeroDivisionError:
    print("⚠️ 除零错误！请检查数据")
finally:
    print("执行结束，无论是否出错都会执行")
```

💡 输出：

```
⚠️ 除零错误！请检查数据
执行结束，无论是否出错都会执行
```

* `try`：尝试执行
* `except`：捕获异常
* `finally`：无论是否出错都会执行（常用作资源释放，例如关闭文件或数据库连接）

---

### 2️⃣ 在监控脚本中的实战

假设我们调用外部 API 获取监控数据，可能出现网络异常或返回异常数据：

```python
import requests

urls = ["http://service1/health", "http://service2/health"]

for url in urls:
    try:
        r = requests.get(url, timeout=5)
        if r.status_code == 200:
            print(f"{url}: ✅ 正常")
        else:
            print(f"{url}: ⚠️ 异常 (status={r.status_code})")
    except requests.exceptions.RequestException as e:
        print(f"{url}: ⚠️ 网络异常 {e}")
```

> 💡 即使其中一个服务请求失败，其他服务仍会继续检查。

---

### 3️⃣ 异常处理 + 日志写入

结合前面学习的日志功能，可以保证即使发生错误，也会记录：

```python
import logging
import requests

logging.basicConfig(filename="monitor.log", level=logging.INFO,
                    format="%(asctime)s - %(levelname)s - %(message)s")

urls = ["http://service1/health", "http://service2/health"]

for url in urls:
    try:
        r = requests.get(url, timeout=5)
        if r.status_code == 200:
            logging.info(f"{url}: ✅ 正常")
        else:
            logging.warning(f"{url}: ⚠️ 异常 (status={r.status_code})")
    except requests.exceptions.RequestException as e:
        logging.error(f"{url}: ⚠️ 网络异常 {e}")
```

💡 输出到 `monitor.log`：

```
2025-10-26 09:55:00 - INFO - http://service1/health: ✅ 正常
2025-10-26 09:55:00 - ERROR - http://service2/health: ⚠️ 网络异常 ConnectionError(...)
```

---

### 4️⃣ 小练习

请你写一个脚本：

> 监控三个服务 CPU 使用率 `[72, 85, 'N/A']`（第三个数据异常）
> 阈值 80
> 使用 `try/except` 捕获异常，输出结果如下：
>
> ```
> CPU 72% - ✅ 正常
> CPU 85% - ⚠️ 超过阈值
> CPU 数据异常 - ⚠️ 请检查
> ```

---

是否希望我接下来：
A. 给出练习答案 + 讲解
B. 总结阶段 1 并进入阶段 2（运维常用模块 + 自动化脚本）


好的 👍 我们完成 **CPU 异常处理练习**，并讲解在 SRE 脚本中的实际应用。

---

## 🧩 练习题：CPU 检测 + 异常处理

**要求回顾：**

* CPU 数据：`[72, 85, 'N/A']`
* 阈值：80
* 输出格式：

```
CPU 72% - ✅ 正常
CPU 85% - ⚠️ 超过阈值
CPU 数据异常 - ⚠️ 请检查
```

* 使用 `try/except` 捕获异常

---

### ✅ 参考答案

```python
# 定义 CPU 检测函数
def check_cpu(usage, threshold):
    try:
        # 尝试将 usage 转为数字
        usage_value = float(usage)
        if usage_value > threshold:
            return f"CPU {usage_value}% - ⚠️ 超过阈值"
        else:
            return f"CPU {usage_value}% - ✅ 正常"
    except (ValueError, TypeError):
        # 如果无法转为数字，返回异常信息
        return "CPU 数据异常 - ⚠️ 请检查"

# CPU 数据与阈值
cpu_list = [72, 85, 'N/A']
cpu_threshold = 80

# 遍历检测
for cpu in cpu_list:
    result = check_cpu(cpu, cpu_threshold)
    print(result)
```

---

### 💡 输出结果

```
CPU 72.0% - ✅ 正常
CPU 85.0% - ⚠️ 超过阈值
CPU 数据异常 - ⚠️ 请检查
```

---

### 🧠 知识点讲解

| 知识点            | 说明                        | SRE 实战意义                  |
| -------------- | ------------------------- | ------------------------- |
| `try/except`   | 捕获可能出错的操作                 | 防止异常中断整个监控脚本              |
| `float(usage)` | 将数据转为数值                   | 支持从 API / 配置文件获取的字符串或异常数据 |
| 多异常类型捕获        | `(ValueError, TypeError)` | 处理不同异常情况，提高脚本健壮性          |
| 返回统一信息         | 函数返回结果                    | 可直接写入日志、报表或发送告警           |

---

### 🔧 实战提示

1. 结合日志写入，将异常记录到文件：

```python
import logging
logging.basicConfig(filename="cpu_monitor.log", level=logging.INFO)
logging.info(result)
```

2. 结合告警推送：

* 当返回包含“⚠️”时，发送邮件或飞书消息通知运维人员

3. 可以扩展为**批量巡检脚本**，循环多个节点 CPU 数据，异常不影响其他节点检查

---

✅ 至此，**阶段 1：巩固基础 + 面向 SRE 的语法强化** 已经完整完成：

* 变量与数据类型
* 条件语句与循环
* 函数与模块
* 文件与日志操作
* 异常处理 + 错误保护

---

接下来可以进入 **阶段 2：运维常用模块 + 自动化脚本**，开始**真正实战监控脚本开发**。

你希望我直接帮你开始阶段 2 的实战讲解吗？
