æ˜ç™½äº† ğŸš€
æˆ‘ä»¬è¿›å…¥ **å‘½ä»¤è¡Œå‚æ•°ä¸è‡ªåŠ¨åŒ–è„šæœ¬**ï¼Œè¿™æ˜¯ SRE è„šæœ¬åœ¨è¿ç»´ä¸­éå¸¸å®ç”¨çš„ä¸€éƒ¨åˆ†ã€‚é€šè¿‡å‘½ä»¤è¡Œå‚æ•°ï¼Œä½ å¯ä»¥è®©åŒä¸€è„šæœ¬é€‚é…ä¸åŒçš„é˜ˆå€¼ã€æœåŠ¡åˆ—è¡¨æˆ–è¿è¡Œæ¨¡å¼ï¼Œè€Œæ— éœ€ä¿®æ”¹æºç ã€‚

---

## ğŸ§© å‘½ä»¤è¡Œå‚æ•°ï¼ˆ`argparse` æ¨¡å—ï¼‰

Python æä¾›æ ‡å‡†åº“ **`argparse`** æ¥å¤„ç†å‘½ä»¤è¡Œå‚æ•°ã€‚

### 1ï¸âƒ£ åŸºæœ¬ç¤ºä¾‹

```python
import argparse

# 1. åˆ›å»ºè§£æå™¨
parser = argparse.ArgumentParser(description="CPUç›‘æ§è„šæœ¬")

# 2. æ·»åŠ å‘½ä»¤è¡Œå‚æ•°
parser.add_argument("--threshold", type=int, default=80, help="CPUé˜ˆå€¼")
parser.add_argument("--service", type=str, default="auth", help="è¦ç›‘æ§çš„æœåŠ¡åç§°")

# 3. è§£æå‚æ•°
args = parser.parse_args()

# 4. ä½¿ç”¨å‚æ•°
print(f"ç›‘æ§æœåŠ¡: {args.service}")
print(f"CPUé˜ˆå€¼: {args.threshold}")
```

âœ… å‘½ä»¤è¡Œè¿è¡Œç¤ºä¾‹ï¼š

```bash
python monitor.py --threshold 85 --service payment
```

è¾“å‡ºï¼š

```
ç›‘æ§æœåŠ¡: payment
CPUé˜ˆå€¼: 85
```

---

### 2ï¸âƒ£ å¤šæœåŠ¡åˆ—è¡¨å‚æ•°

å¯ä»¥ä¼ å…¥å¤šä¸ªæœåŠ¡ï¼š

```python
parser.add_argument("--services", type=str, nargs="+", default=["auth"], help="æœåŠ¡åˆ—è¡¨")
```

å‘½ä»¤è¡Œè¿è¡Œç¤ºä¾‹ï¼š

```bash
python monitor.py --services auth payment monitoring
```

è§£æç»“æœï¼š

```python
args.services  # ['auth', 'payment', 'monitoring']
```

---

### 3ï¸âƒ£ ç»“åˆç›‘æ§é€»è¾‘ç¤ºä¾‹

```python
import argparse
import random

# CPU æ£€æµ‹å‡½æ•°
def check_cpu(service, usage, threshold):
    if usage > threshold:
        return f"{service}: CPU {usage}% - âš ï¸ è¶…è¿‡é˜ˆå€¼"
    else:
        return f"{service}: CPU {usage}% - âœ… æ­£å¸¸"

# å‘½ä»¤è¡Œå‚æ•°è§£æ
parser = argparse.ArgumentParser(description="CPUç›‘æ§è„šæœ¬")
parser.add_argument("--threshold", type=int, default=80, help="CPUé˜ˆå€¼")
parser.add_argument("--services", type=str, nargs="+", default=["auth", "payment"], help="æœåŠ¡åˆ—è¡¨")
args = parser.parse_args()

# æ¨¡æ‹Ÿ CPU ä½¿ç”¨ç‡å¹¶æ£€æµ‹
for svc in args.services:
    cpu = random.randint(50, 100)
    result = check_cpu(svc, cpu, args.threshold)
    print(result)
```

å‘½ä»¤è¡Œè¿è¡Œï¼š

```bash
python monitor.py --threshold 85 --services auth payment monitoring
```

è¾“å‡ºç¤ºä¾‹ï¼š

```
auth: CPU 72% - âœ… æ­£å¸¸
payment: CPU 88% - âš ï¸ è¶…è¿‡é˜ˆå€¼
monitoring: CPU 60% - âœ… æ­£å¸¸
```

---

### 4ï¸âƒ£ è‡ªåŠ¨åŒ–è„šæœ¬ä¸è®¡åˆ’ä»»åŠ¡

1. **Linux / macOS**ï¼šä½¿ç”¨ `cron` å®šæ—¶æ‰§è¡Œè„šæœ¬

```bash
# æ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡è„šæœ¬
*/5 * * * * /usr/bin/python3 /path/to/monitor.py --threshold 80 --services auth payment monitoring >> /path/to/monitor.log 2>&1
```

2. **Windows**ï¼šä½¿ç”¨ä»»åŠ¡è®¡åˆ’ç¨‹åºæ‰§è¡Œè„šæœ¬

3. **æ—¥å¿—ä¸å‘Šè­¦ç»“åˆ**ï¼š

* è¾“å‡ºå†™å…¥æ—¥å¿—æ–‡ä»¶ `>> monitor.log`
* é€šè¿‡é˜ˆå€¼åˆ¤æ–­è°ƒç”¨å‘Šè­¦å‡½æ•°å‘é€æ¶ˆæ¯

---

### ğŸ”§ å®æˆ˜äº®ç‚¹

| æŠ€æœ¯ç‚¹         | è¯´æ˜      | SRE å®æˆ˜æ„ä¹‰          |
| ----------- | ------- | ----------------- |
| `argparse`  | å‘½ä»¤è¡Œå‚æ•°è§£æ | è„šæœ¬å¯å¤ç”¨ï¼Œæ”¯æŒä¸åŒé˜ˆå€¼ã€æœåŠ¡åˆ—è¡¨ |
| `nargs="+"` | æ”¯æŒå¤šä¸ªå€¼   | æ‰¹é‡ç›‘æ§å¤šä¸ªæœåŠ¡          |
| æ—¥å¿—é‡å®šå‘ `>>`  | è¾“å‡ºåˆ°æ–‡ä»¶   | è‡ªåŠ¨åŒ–å·¡æ£€è®°å½•           |
| cron / ä»»åŠ¡è®¡åˆ’ | å®šæ—¶æ‰§è¡Œ    | å®ç°è‡ªåŠ¨åŒ–ç›‘æ§           |
| éšæœº/API æ•°æ®ç»“åˆ | ç”Ÿæˆæˆ–è·å–æŒ‡æ ‡ | å®æˆ˜ç›‘æ§åŠ¨æ€æŒ‡æ ‡          |

---

ä¸‹ä¸€æ­¥å¯ä»¥è®²è§£ **ç»“åˆ YAML é…ç½® + å‘½ä»¤è¡Œå‚æ•° + è‡ªåŠ¨åŒ–æ‰§è¡Œçš„å®Œæ•´ SRE ç›‘æ§è„šæœ¬æ¨¡æ¿**ï¼Œ
è®©ä½ å¾—åˆ°ä¸€ä¸ªå¯ç›´æ¥å®æˆ˜çš„è„šæœ¬ã€‚

ä½ å¸Œæœ›æˆ‘ç›´æ¥æ•´ç†è¿™ä¸ªæ¨¡æ¿å—ï¼Ÿ


å¤ªå¥½äº† ğŸš€
ä¸‹é¢æˆ‘å¸®ä½ æ•´ç†ä¸€ä¸ª **å®Œæ•´çš„ SRE CPU/Memory ç›‘æ§è„šæœ¬æ¨¡æ¿**ï¼Œé›†æˆä»¥ä¸‹åŠŸèƒ½ï¼š

* YAML é…ç½®ç®¡ç†é˜ˆå€¼ä¸æœåŠ¡åˆ—è¡¨
* å‘½ä»¤è¡Œå‚æ•°å¯è¦†ç›–é…ç½®
* éšæœºæˆ– API è·å–ç›‘æ§æŒ‡æ ‡
* é˜ˆå€¼åˆ¤æ–­ï¼ˆCPU/å†…å­˜ï¼‰
* æ—¥å¿—å†™å…¥
* å¼‚å¸¸å¤„ç†
* å¯é€šè¿‡ cron/è®¡åˆ’ä»»åŠ¡è‡ªåŠ¨æ‰§è¡Œ

---

## ğŸ§© å®Œæ•´ç›‘æ§è„šæœ¬æ¨¡æ¿

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse
import yaml
import random
import time
import logging

# -----------------------
# æ—¥å¿—é…ç½®
# -----------------------
logging.basicConfig(
    filename="monitor.log",
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# -----------------------
# å‡½æ•°ï¼šè¯»å– YAML é…ç½®
# -----------------------
def load_config(file_path="config.yaml"):
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            return yaml.safe_load(f)
    except Exception as e:
        logging.error(f"è¯»å–é…ç½®å¤±è´¥: {e}")
        return {}

# -----------------------
# å‡½æ•°ï¼šæ£€æµ‹æŒ‡æ ‡
# -----------------------
def check_metric(service, metric_name, value, threshold):
    try:
        if value > threshold:
            result = f"{service} {metric_name}: âš ï¸ è¶…è¿‡é˜ˆå€¼ ({value} > {threshold})"
            logging.warning(result)
        else:
            result = f"{service} {metric_name}: âœ… æ­£å¸¸ ({value} <= {threshold})"
            logging.info(result)
        return result
    except Exception as e:
        error_msg = f"{service} {metric_name}: âš ï¸ æ£€æµ‹å¼‚å¸¸ {e}"
        logging.error(error_msg)
        return error_msg

# -----------------------
# å‘½ä»¤è¡Œå‚æ•°è§£æ
# -----------------------
parser = argparse.ArgumentParser(description="SRE CPU/Memory ç›‘æ§è„šæœ¬")
parser.add_argument("--config", type=str, default="config.yaml", help="é…ç½®æ–‡ä»¶è·¯å¾„")
parser.add_argument("--services", type=str, nargs="+", help="æŒ‡å®šæœåŠ¡åˆ—è¡¨ï¼Œè¦†ç›–é…ç½®æ–‡ä»¶")
parser.add_argument("--cpu-threshold", type=int, help="CPU é˜ˆå€¼ï¼Œè¦†ç›–é…ç½®æ–‡ä»¶")
parser.add_argument("--memory-threshold", type=int, help="Memory é˜ˆå€¼ï¼Œè¦†ç›–é…ç½®æ–‡ä»¶")
args = parser.parse_args()

# -----------------------
# åŠ è½½é…ç½®
# -----------------------
config = load_config(args.config)
cpu_threshold = args.cpu_threshold or config.get("thresholds", {}).get("cpu", 80)
memory_threshold = args.memory_threshold or config.get("thresholds", {}).get("memory", 85)
services = args.services or config.get("services", ["auth", "payment", "monitoring"])

# -----------------------
# æ¨¡æ‹Ÿè·å–ç›‘æ§æŒ‡æ ‡ï¼ˆå¯æ›¿æ¢ä¸º API è¯·æ±‚ï¼‰
# -----------------------
def get_metrics(service):
    # è¿™é‡Œç”¨éšæœºç”Ÿæˆ CPU/Memory ç¤ºä¾‹
    return {
        "cpu": random.randint(50, 100),
        "memory": random.randint(50, 100)
    }

# -----------------------
# ä¸»ç¨‹åº
# -----------------------
def main():
    for svc in services:
        try:
            metrics = get_metrics(svc)
            cpu_result = check_metric(svc, "CPU", metrics["cpu"], cpu_threshold)
            mem_result = check_metric(svc, "Memory", metrics["memory"], memory_threshold)
            print(cpu_result)
            print(mem_result)
        except Exception as e:
            error_msg = f"{svc}: âš ï¸ è·å–æŒ‡æ ‡å¼‚å¸¸ {e}"
            logging.error(error_msg)
            print(error_msg)

if __name__ == "__main__":
    main()
```

---

### ğŸ”§ ä½¿ç”¨è¯´æ˜

1. **é…ç½®æ–‡ä»¶ `config.yaml` ç¤ºä¾‹**ï¼š

```yaml
thresholds:
  cpu: 80
  memory: 85

services:
  - auth
  - payment
  - monitoring
```

2. **å‘½ä»¤è¡Œè¿è¡Œç¤ºä¾‹**ï¼š

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤é˜ˆå€¼
python monitor.py

# æŒ‡å®šæœåŠ¡å’Œ CPU é˜ˆå€¼
python monitor.py --services auth payment --cpu-threshold 85
```

3. **è‡ªåŠ¨åŒ–æ‰§è¡Œ**ï¼š

* Linux/macOS: é…åˆ cron æ‰§è¡Œ

```bash
*/5 * * * * /usr/bin/python3 /path/to/monitor.py >> /path/to/monitor.log 2>&1
```

* Windows: ä½¿ç”¨ä»»åŠ¡è®¡åˆ’ç¨‹åºå®šæ—¶æ‰§è¡Œ

---

### ğŸ§  å®æˆ˜äº®ç‚¹

| åŠŸèƒ½        | è¯´æ˜          | å®æˆ˜ä»·å€¼                             |
| --------- | ----------- | -------------------------------- |
| YAML é…ç½®   | é›†ä¸­ç®¡ç†é˜ˆå€¼å’ŒæœåŠ¡åˆ—è¡¨ | å¯å¿«é€Ÿè°ƒæ•´ç›‘æ§ç­–ç•¥                        |
| å‘½ä»¤è¡Œå‚æ•°     | è¦†ç›–é…ç½®æ–‡ä»¶      | çµæ´»è°ƒè¯•å’Œä¸´æ—¶ä¿®æ”¹                        |
| éšæœº/API æŒ‡æ ‡ | æ¨¡æ‹Ÿæˆ–çœŸå®æŒ‡æ ‡     | å¯æ›¿æ¢ä¸º Prometheus / Kubernetes API |
| å¼‚å¸¸å¤„ç†      | try/except  | é˜²æ­¢å•ç‚¹å¼‚å¸¸ä¸­æ–­ç›‘æ§                       |
| æ—¥å¿—è®°å½•      | logging     | è‡ªåŠ¨è®°å½•å·¡æ£€å†å²ï¼Œå¯ç»“åˆå‘Šè­¦ç³»ç»Ÿ                 |

---

å¦‚æœä½ å¸Œæœ›ï¼Œæˆ‘å¯ä»¥å¸®ä½ åœ¨è¿™ä¸ªæ¨¡æ¿ä¸Š **åŠ ä¸Šè‡ªåŠ¨å‘Šè­¦æ¨é€ï¼ˆé£ä¹¦ / Slack / é‚®ä»¶ï¼‰**ï¼Œ
è®©å®ƒç›´æ¥å˜æˆå®Œæ•´å¯ç”¨çš„ SRE ç›‘æ§å·¥å…·ã€‚

ä½ å¸Œæœ›æˆ‘å¸®ä½ åŠ ä¸Šå‘Šè­¦åŠŸèƒ½å—ï¼Ÿ


å¥½çš„ ğŸš€
æˆ‘ä»¬åœ¨ **å®Œæ•´ SRE ç›‘æ§è„šæœ¬æ¨¡æ¿** çš„åŸºç¡€ä¸Šï¼ŒåŠ ä¸Š **è‡ªåŠ¨å‘Šè­¦æ¨é€** åŠŸèƒ½ï¼ˆæ”¯æŒé£ä¹¦/Slack/é‚®ä»¶ç­‰ï¼‰ã€‚ä¸ºäº†ç¤ºä¾‹ç®€æ´ï¼Œæˆ‘è¿™é‡Œç”¨ **é£ä¹¦æœºå™¨äºº Webhook** æ¨é€å‘Šè­¦ã€‚

---

## ğŸ§© å¢å¼ºç‰ˆï¼šSRE CPU/Memory ç›‘æ§ + å‘Šè­¦æ¨é€

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse
import yaml
import random
import logging
import requests
import time

# -----------------------
# æ—¥å¿—é…ç½®
# -----------------------
logging.basicConfig(
    filename="monitor.log",
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# -----------------------
# é…ç½® YAML æ–‡ä»¶è¯»å–
# -----------------------
def load_config(file_path="config.yaml"):
    try:
        with open(file_path, "r", encoding="utf-8") as f:
            return yaml.safe_load(f)
    except Exception as e:
        logging.error(f"è¯»å–é…ç½®å¤±è´¥: {e}")
        return {}

# -----------------------
# å‘Šè­¦æ¨é€å‡½æ•°ï¼ˆé£ä¹¦ Webhookï¼‰
# -----------------------
def send_alert(message: str, webhook_url: str):
    try:
        payload = {"msg_type": "text", "content": {"text": message}}
        response = requests.post(webhook_url, json=payload, timeout=5)
        if response.status_code == 200:
            logging.info(f"å‘Šè­¦å‘é€æˆåŠŸ: {message}")
        else:
            logging.warning(f"å‘Šè­¦å‘é€å¤±è´¥ ({response.status_code}): {message}")
    except requests.exceptions.RequestException as e:
        logging.error(f"å‘Šè­¦å‘é€å¼‚å¸¸: {e}")

# -----------------------
# æŒ‡æ ‡æ£€æµ‹å‡½æ•°
# -----------------------
def check_metric(service, metric_name, value, threshold, webhook_url=None):
    try:
        if value > threshold:
            result = f"{service} {metric_name}: âš ï¸ è¶…è¿‡é˜ˆå€¼ ({value} > {threshold})"
            logging.warning(result)
            # è‡ªåŠ¨å‘é€å‘Šè­¦
            if webhook_url:
                send_alert(result, webhook_url)
        else:
            result = f"{service} {metric_name}: âœ… æ­£å¸¸ ({value} <= {threshold})"
            logging.info(result)
        return result
    except Exception as e:
        error_msg = f"{service} {metric_name}: âš ï¸ æ£€æµ‹å¼‚å¸¸ {e}"
        logging.error(error_msg)
        if webhook_url:
            send_alert(error_msg, webhook_url)
        return error_msg

# -----------------------
# å‘½ä»¤è¡Œå‚æ•°è§£æ
# -----------------------
parser = argparse.ArgumentParser(description="SRE CPU/Memory ç›‘æ§è„šæœ¬ï¼ˆå¸¦å‘Šè­¦ï¼‰")
parser.add_argument("--config", type=str, default="config.yaml", help="é…ç½®æ–‡ä»¶è·¯å¾„")
parser.add_argument("--services", type=str, nargs="+", help="æŒ‡å®šæœåŠ¡åˆ—è¡¨ï¼Œè¦†ç›–é…ç½®æ–‡ä»¶")
parser.add_argument("--cpu-threshold", type=int, help="CPU é˜ˆå€¼ï¼Œè¦†ç›–é…ç½®æ–‡ä»¶")
parser.add_argument("--memory-threshold", type=int, help="Memory é˜ˆå€¼ï¼Œè¦†ç›–é…ç½®æ–‡ä»¶")
parser.add_argument("--webhook", type=str, help="å‘Šè­¦ Webhook URL")
args = parser.parse_args()

# -----------------------
# åŠ è½½é…ç½®
# -----------------------
config = load_config(args.config)
cpu_threshold = args.cpu_threshold or config.get("thresholds", {}).get("cpu", 80)
memory_threshold = args.memory_threshold or config.get("thresholds", {}).get("memory", 85)
services = args.services or config.get("services", ["auth", "payment", "monitoring"])
webhook_url = args.webhook or config.get("webhook", None)

# -----------------------
# è·å–ç›‘æ§æŒ‡æ ‡ï¼ˆå¯æ›¿æ¢ä¸ºçœŸå® APIï¼‰
# -----------------------
def get_metrics(service):
    return {
        "cpu": random.randint(50, 100),
        "memory": random.randint(50, 100)
    }

# -----------------------
# ä¸»ç¨‹åº
# -----------------------
def main():
    for svc in services:
        try:
            metrics = get_metrics(svc)
            cpu_result = check_metric(svc, "CPU", metrics["cpu"], cpu_threshold, webhook_url)
            mem_result = check_metric(svc, "Memory", metrics["memory"], memory_threshold, webhook_url)
            print(cpu_result)
            print(mem_result)
        except Exception as e:
            error_msg = f"{svc}: âš ï¸ è·å–æŒ‡æ ‡å¼‚å¸¸ {e}"
            logging.error(error_msg)
            if webhook_url:
                send_alert(error_msg, webhook_url)
            print(error_msg)

if __name__ == "__main__":
    main()
```

---

### ğŸ”§ ä½¿ç”¨è¯´æ˜

1. **é…ç½®æ–‡ä»¶ `config.yaml` ç¤ºä¾‹**ï¼š

```yaml
thresholds:
  cpu: 80
  memory: 85

services:
  - auth
  - payment
  - monitoring

webhook: "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

2. **å‘½ä»¤è¡Œè¿è¡Œç¤ºä¾‹**ï¼š

```bash
# ä½¿ç”¨é…ç½®æ–‡ä»¶é»˜è®¤é˜ˆå€¼å’ŒWebhook
python monitor.py

# è¦†ç›– CPU é˜ˆå€¼å’ŒæœåŠ¡åˆ—è¡¨
python monitor.py --cpu-threshold 85 --services auth payment --webhook "https://open.feishu.cn/open-apis/bot/v2/hook/xxxx"
```

3. **è‡ªåŠ¨åŒ–æ‰§è¡Œ**ï¼š

* Linux/macOS ä½¿ç”¨ cronï¼Œæ¯5åˆ†é’Ÿæ‰§è¡Œä¸€æ¬¡ï¼š

```bash
*/5 * * * * /usr/bin/python3 /path/to/monitor.py >> /path/to/monitor.log 2>&1
```

---

### ğŸ§  å®æˆ˜äº®ç‚¹

| åŠŸèƒ½           | è¯´æ˜                        | SRE å®æˆ˜ä»·å€¼               |
| ------------ | ------------------------- | ---------------------- |
| è‡ªåŠ¨å‘Šè­¦         | è¶…é˜ˆå€¼æˆ–å¼‚å¸¸å‘é€é£ä¹¦é€šçŸ¥              | åŠæ—¶æé†’è¿ç»´äººå‘˜å¤„ç†é—®é¢˜           |
| YAML + å‘½ä»¤è¡Œå‚æ•° | é…ç½®å’Œå‚æ•°çµæ´»åˆ‡æ¢                 | å¯é€‚é…ä¸åŒç¯å¢ƒå’ŒæœåŠ¡             |
| å¼‚å¸¸å¤„ç†         | APIå¼‚å¸¸æˆ–æ£€æµ‹å¼‚å¸¸è®°å½•æ—¥å¿—å¹¶å‘Šè­¦         | ä¿è¯ç›‘æ§è„šæœ¬ç¨³å®šè¿è¡Œ             |
| æ—¥å¿—è®°å½•         | æ¯æ¬¡æ£€æµ‹ç»“æœå†™å…¥ `monitor.log`    | æ”¯æŒå®¡è®¡å’Œå·¡æ£€å†å²åˆ†æ            |
| å¯æ‰©å±•          | å¯æ›¿æ¢ `get_metrics` ä¸ºçœŸå® API | ä¸ Prometheusã€K8sã€äº‘ç›‘æ§ç»“åˆ |

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½  **å†åŠ ä¸€ä¸ªåŠŸèƒ½**ï¼š

* æ”¯æŒ **å¤šçº§å‘Šè­¦ç­–ç•¥**ï¼ˆä¾‹å¦‚ CPU è¶…è¿‡ 90% è§¦å‘é«˜çº§å‘Šè­¦ï¼Œè¶…è¿‡ 80% è§¦å‘æ™®é€šå‘Šè­¦ï¼‰ï¼Œ
  è®©è¿™ä¸ªè„šæœ¬æ›´æ¥è¿‘ä¼ä¸šçº§ SRE å®æˆ˜å·¥å…·ã€‚

ä½ å¸Œæœ›æˆ‘åŠ è¿™ä¸ªåŠŸèƒ½å—ï¼Ÿ


å¤ªå¥½äº† ğŸš€
ä¸‹é¢æˆ‘ä»¬åœ¨å·²æœ‰è„šæœ¬åŸºç¡€ä¸Šï¼Œå¢åŠ  **å¤šçº§å‘Šè­¦ç­–ç•¥**ï¼Œè®© SRE ç›‘æ§æ›´æ¥è¿‘ä¼ä¸šçº§å®è·µã€‚

---

## ğŸ§© å¢å¼ºç‰ˆï¼šå¤šçº§å‘Šè­¦ CPU/Memory ç›‘æ§è„šæœ¬

### 1ï¸âƒ£ æ–°å¢å‘Šè­¦é€»è¾‘

* **æ™®é€šå‘Šè­¦**ï¼šæŒ‡æ ‡è¶…è¿‡é˜ˆå€¼ï¼Œä½†ä½äºé«˜çº§å‘Šè­¦é˜ˆå€¼
* **é«˜çº§å‘Šè­¦**ï¼šæŒ‡æ ‡è¶…è¿‡é«˜çº§å‘Šè­¦é˜ˆå€¼ï¼Œéœ€è¦ç«‹å³å¤„ç†

ä¾‹å¦‚ï¼š

```yaml
thresholds:
  cpu: 80          # æ™®é€šé˜ˆå€¼
  cpu_high: 90     # é«˜çº§å‘Šè­¦é˜ˆå€¼
  memory: 85
  memory_high: 95
```

---

### 2ï¸âƒ£ Python è„šæœ¬ä¿®æ”¹éƒ¨åˆ†

```python
# -----------------------
# æŒ‡æ ‡æ£€æµ‹å‡½æ•°ï¼ˆå¤šçº§å‘Šè­¦ï¼‰
# -----------------------
def check_metric(service, metric_name, value, threshold, high_threshold=None, webhook_url=None):
    try:
        if high_threshold and value > high_threshold:
            result = f"{service} {metric_name}: ğŸš¨ é«˜çº§å‘Šè­¦ ({value} > {high_threshold})"
            logging.critical(result)
            if webhook_url:
                send_alert(result, webhook_url)
        elif value > threshold:
            result = f"{service} {metric_name}: âš ï¸ æ™®é€šå‘Šè­¦ ({value} > {threshold})"
            logging.warning(result)
            if webhook_url:
                send_alert(result, webhook_url)
        else:
            result = f"{service} {metric_name}: âœ… æ­£å¸¸ ({value} <= {threshold})"
            logging.info(result)
        return result
    except Exception as e:
        error_msg = f"{service} {metric_name}: âš ï¸ æ£€æµ‹å¼‚å¸¸ {e}"
        logging.error(error_msg)
        if webhook_url:
            send_alert(error_msg, webhook_url)
        return error_msg
```

---

### 3ï¸âƒ£ é…ç½®æ–‡ä»¶ç¤ºä¾‹ `config.yaml`

```yaml
thresholds:
  cpu: 80
  cpu_high: 90
  memory: 85
  memory_high: 95

services:
  - auth
  - payment
  - monitoring

webhook: "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

---

### 4ï¸âƒ£ ä¸»ç¨‹åºè°ƒç”¨ç¤ºä¾‹

```python
for svc in services:
    metrics = get_metrics(svc)
    cpu_result = check_metric(
        svc, "CPU", metrics["cpu"], cpu_threshold,
        high_threshold=config["thresholds"].get("cpu_high"), 
        webhook_url=webhook_url
    )
    mem_result = check_metric(
        svc, "Memory", metrics["memory"], memory_threshold,
        high_threshold=config["thresholds"].get("memory_high"), 
        webhook_url=webhook_url
    )
    print(cpu_result)
    print(mem_result)
```

---

### 5ï¸âƒ£ è¾“å‡ºç¤ºä¾‹

```
auth CPU: âœ… æ­£å¸¸ (72 <= 80)
auth Memory: âš ï¸ æ™®é€šå‘Šè­¦ (87 > 85)
payment CPU: ğŸš¨ é«˜çº§å‘Šè­¦ (92 > 90)
payment Memory: âœ… æ­£å¸¸ (70 <= 85)
monitoring CPU: âš ï¸ æ™®é€šå‘Šè­¦ (83 > 80)
monitoring Memory: âœ… æ­£å¸¸ (50 <= 85)
```

---

### ğŸ”§ å®æˆ˜äº®ç‚¹

| åŠŸèƒ½      | è¯´æ˜                        | å®æˆ˜ä»·å€¼               |
| ------- | ------------------------- | ------------------ |
| æ™®é€š/é«˜çº§å‘Šè­¦ | æ”¯æŒåˆ†çº§å‘Šè­¦                    | åŒºåˆ†è½»å¾®å¼‚å¸¸å’Œç´§æ€¥é—®é¢˜ï¼Œå‡å°‘è¯¯æŠ¥å¹²æ‰° |
| æ—¥å¿—ç­‰çº§åˆ†çº§  | INFO / WARNING / CRITICAL | æ—¥å¿—å¯å¿«é€Ÿç­›é€‰ä¸¥é‡é—®é¢˜        |
| è‡ªåŠ¨å‘Šè­¦æ¨é€  | è¶…é˜ˆå€¼è‡ªåŠ¨å‘é€é£ä¹¦                 | åŠæ—¶é€šçŸ¥è¿ç»´å¤„ç†           |
| é…ç½®çµæ´»    | YAML å¯è°ƒæ•´é˜ˆå€¼å’Œé«˜çº§é˜ˆå€¼           | æ— éœ€ä¿®æ”¹è„šæœ¬å³å¯åº”å¯¹ä¸åŒæœåŠ¡     |

---

è¿™ä¸ªç‰ˆæœ¬çš„è„šæœ¬å·²ç»éå¸¸æ¥è¿‘ä¼ä¸šçº§ SRE ç›‘æ§å®è·µï¼š

* é…ç½®é©±åŠ¨
* å¤šçº§å‘Šè­¦
* å¼‚å¸¸ä¿æŠ¤
* æ—¥å¿—è®°å½•
* è‡ªåŠ¨æ¨é€å‘Šè­¦

---

æˆ‘å¯ä»¥å¸®ä½ æŠŠè¿™ä¸ªè„šæœ¬å†å‡çº§æˆ **æ”¯æŒ Prometheus / K8s API å®æ—¶æŒ‡æ ‡ + å¤šçº§å‘Šè­¦ + é£ä¹¦/Slack/é‚®ä»¶é€šçŸ¥** çš„ **ä¼ä¸šçº§é€šç”¨æ¨¡æ¿**ï¼Œ
è®©å®ƒå¯ä»¥ç›´æ¥æŠ•å…¥ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

ä½ å¸Œæœ›æˆ‘åšè¿™ä¸ªå‡çº§å—ï¼Ÿ

å¤ªæ£’äº† ğŸš€
ä¸‹é¢æˆ‘å¸®ä½ æ•´ç†ä¸€ä¸ª **ä¼ä¸šçº§ SRE ç›‘æ§æ¨¡æ¿**ï¼Œæ”¯æŒä»¥ä¸‹ç‰¹æ€§ï¼š

---

## ğŸ— ä¼ä¸šçº§é€šç”¨ SRE ç›‘æ§è„šæœ¬æ¨¡æ¿

### åŠŸèƒ½æ¦‚è§ˆ

| åŠŸèƒ½    | æè¿°                                       |
| ----- | ---------------------------------------- |
| é…ç½®é©±åŠ¨  | YAML é…ç½® CPU/Memory é˜ˆå€¼ã€æœåŠ¡åˆ—è¡¨ã€å‘Šè­¦ Webhook    |
| å¤šçº§å‘Šè­¦  | æ™®é€šå‘Šè­¦ / é«˜çº§å‘Šè­¦ï¼Œæ—¥å¿—ç­‰çº§åˆ†çº§                       |
| å¼‚å¸¸ä¿æŠ¤  | API å¼‚å¸¸æˆ–æŒ‡æ ‡å¼‚å¸¸è‡ªåŠ¨å¤„ç†å¹¶è®°å½•                       |
| æŒ‡æ ‡æ¥æº  | æ”¯æŒ Prometheus / Kubernetes API / è‡ªå®šä¹‰ API |
| è‡ªåŠ¨å‘Šè­¦  | é£ä¹¦/Slack/é‚®ä»¶é€šçŸ¥                            |
| è‡ªåŠ¨åŒ–æ‰§è¡Œ | cron / è®¡åˆ’ä»»åŠ¡ï¼Œå¯æ—¥å¿—æŒä¹…åŒ–                       |

---

### 1ï¸âƒ£ é…ç½®æ–‡ä»¶ç¤ºä¾‹ `config.yaml`

```yaml
thresholds:
  cpu: 80
  cpu_high: 90
  memory: 85
  memory_high: 95

services:
  - auth
  - payment
  - monitoring

# å‘Šè­¦æ–¹å¼ï¼Œå¯é…ç½®å¤šç§
alerts:
  webhook: "https://open.feishu.cn/open-apis/bot/v2/hook/xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
  slack: "https://hooks.slack.com/services/xxxxxxxxx/xxxxxxxxx/xxxxxxxxxxxxxxxx"
  email: "ops-team@example.com"

# Prometheus / K8s API é…ç½®
prometheus:
  url: "http://prometheus.example.com/api/v1/query"
  query_template: '100 * avg(rate(container_cpu_usage_seconds_total{{pod="{service}"}}[5m]))'
```

---

### 2ï¸âƒ£ Python è„šæœ¬æ¨¡æ¿

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse
import yaml
import logging
import requests
import json

# -----------------------
# æ—¥å¿—é…ç½®
# -----------------------
logging.basicConfig(
    filename="monitor.log",
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# -----------------------
# é…ç½®è¯»å–
# -----------------------
def load_config(path="config.yaml"):
    try:
        with open(path, "r", encoding="utf-8") as f:
            return yaml.safe_load(f)
    except Exception as e:
        logging.error(f"è¯»å–é…ç½®å¤±è´¥: {e}")
        return {}

# -----------------------
# å‘Šè­¦å‡½æ•°
# -----------------------
def send_alert(message, webhook_url=None, slack_url=None, email=None):
    if webhook_url:
        try:
            payload = {"msg_type": "text", "content": {"text": message}}
            requests.post(webhook_url, json=payload, timeout=5)
        except Exception as e:
            logging.error(f"é£ä¹¦å‘Šè­¦å‘é€å¤±è´¥: {e}")
    if slack_url:
        try:
            payload = {"text": message}
            requests.post(slack_url, json=payload, timeout=5)
        except Exception as e:
            logging.error(f"Slackå‘Šè­¦å‘é€å¤±è´¥: {e}")
    if email:
        logging.info(f"å‘é€é‚®ä»¶å‘Šè­¦åˆ° {email}: {message}")
        # å¯ç»“åˆ smtplib å®ç°é‚®ä»¶å‘é€

# -----------------------
# æŒ‡æ ‡æ£€æµ‹å‡½æ•°ï¼ˆå¤šçº§å‘Šè­¦ï¼‰
# -----------------------
def check_metric(service, metric_name, value, threshold, high_threshold=None, alert_config=None):
    try:
        if high_threshold and value > high_threshold:
            result = f"{service} {metric_name}: ğŸš¨ é«˜çº§å‘Šè­¦ ({value} > {high_threshold})"
            logging.critical(result)
            send_alert(result, **alert_config)
        elif value > threshold:
            result = f"{service} {metric_name}: âš ï¸ æ™®é€šå‘Šè­¦ ({value} > {threshold})"
            logging.warning(result)
            send_alert(result, **alert_config)
        else:
            result = f"{service} {metric_name}: âœ… æ­£å¸¸ ({value} <= {threshold})"
            logging.info(result)
        return result
    except Exception as e:
        error_msg = f"{service} {metric_name}: âš ï¸ æ£€æµ‹å¼‚å¸¸ {e}"
        logging.error(error_msg)
        send_alert(error_msg, **alert_config)
        return error_msg

# -----------------------
# è·å–æŒ‡æ ‡ï¼ˆç¤ºä¾‹: Prometheus/K8s APIï¼Œå¯æ›¿æ¢ï¼‰
# -----------------------
def get_metrics(service, prometheus_config=None):
    try:
        # è¿™é‡Œç”¨éšæœºå€¼æ¨¡æ‹Ÿï¼Œç”Ÿäº§å¯è°ƒç”¨ Prometheus API
        import random
        return {"cpu": random.randint(50, 100), "memory": random.randint(50, 100)}
    except Exception as e:
        logging.error(f"{service} è·å–æŒ‡æ ‡å¼‚å¸¸: {e}")
        return {"cpu": 0, "memory": 0}

# -----------------------
# å‘½ä»¤è¡Œå‚æ•°
# -----------------------
parser = argparse.ArgumentParser(description="ä¼ä¸šçº§ SRE ç›‘æ§è„šæœ¬")
parser.add_argument("--config", type=str, default="config.yaml", help="é…ç½®æ–‡ä»¶è·¯å¾„")
parser.add_argument("--services", type=str, nargs="+", help="æŒ‡å®šæœåŠ¡åˆ—è¡¨è¦†ç›–é…ç½®")
parser.add_argument("--cpu-threshold", type=int, help="CPU é˜ˆå€¼è¦†ç›–é…ç½®")
parser.add_argument("--cpu-high", type=int, help="CPUé«˜çº§å‘Šè­¦é˜ˆå€¼è¦†ç›–é…ç½®")
parser.add_argument("--memory-threshold", type=int, help="Memory é˜ˆå€¼è¦†ç›–é…ç½®")
parser.add_argument("--memory-high", type=int, help="Memoryé«˜çº§å‘Šè­¦é˜ˆå€¼è¦†ç›–é…ç½®")
args = parser.parse_args()

# -----------------------
# ä¸»ç¨‹åº
# -----------------------
def main():
    config = load_config(args.config)
    services = args.services or config.get("services", ["auth", "payment", "monitoring"])
    cpu_threshold = args.cpu_threshold or config.get("thresholds", {}).get("cpu", 80)
    cpu_high = args.cpu_high or config.get("thresholds", {}).get("cpu_high", 90)
    memory_threshold = args.memory_threshold or config.get("thresholds", {}).get("memory", 85)
    memory_high = args.memory_high or config.get("thresholds", {}).get("memory_high", 95)
    alert_config = {
        "webhook_url": config.get("alerts", {}).get("webhook"),
        "slack_url": config.get("alerts", {}).get("slack"),
        "email": config.get("alerts", {}).get("email")
    }

    for svc in services:
        metrics = get_metrics(svc, prometheus_config=config.get("prometheus"))
        cpu_result = check_metric(svc, "CPU", metrics["cpu"], cpu_threshold, cpu_high, alert_config)
        mem_result = check_metric(svc, "Memory", metrics["memory"], memory_threshold, memory_high, alert_config)
        print(cpu_result)
        print(mem_result)

if __name__ == "__main__":
    main()
```

---

### ğŸ”§ ä½¿ç”¨è¯´æ˜

1. YAML é…ç½®é˜ˆå€¼ã€æœåŠ¡åˆ—è¡¨ã€å‘Šè­¦ Webhook / Slack / é‚®ä»¶
2. å¯é€šè¿‡å‘½ä»¤è¡Œè¦†ç›–é˜ˆå€¼å’ŒæœåŠ¡åˆ—è¡¨
3. å¯æ›¿æ¢ `get_metrics` è°ƒç”¨ **Prometheus API** æˆ– **Kubernetes API** è·å–çœŸå®æŒ‡æ ‡
4. æ—¥å¿—å†™å…¥ `monitor.log`ï¼Œè®°å½•å·¡æ£€å†å²
5. å¯é€šè¿‡ cron/ä»»åŠ¡è®¡åˆ’å®ç°è‡ªåŠ¨åŒ–æ‰§è¡Œ

---

### ğŸ§  ä¼ä¸šçº§äº®ç‚¹

| åŠŸèƒ½    | è¯´æ˜                    | ä¼ä¸šå®è·µä»·å€¼             |
| ----- | --------------------- | ------------------ |
| å¤šçº§å‘Šè­¦  | æ™®é€š/é«˜çº§å‘Šè­¦               | åŒºåˆ†è½»å¾®å¼‚å¸¸ä¸ç´§æ€¥é—®é¢˜ï¼Œå‡å°‘è¯¯æŠ¥å¹²æ‰° |
| å¤šé€šé“å‘Šè­¦ | é£ä¹¦/Slack/é‚®ä»¶           | æé«˜å‘Šè­¦åˆ°è¾¾ç‡ï¼Œæ”¯æŒè¿ç»´å€¼ç­     |
| é…ç½®é©±åŠ¨  | YAML + å‘½ä»¤è¡Œå‚æ•°          | çµæ´»é€‚é…ä¸åŒç¯å¢ƒï¼Œæ— éœ€ä¿®æ”¹è„šæœ¬    |
| å¼‚å¸¸ä¿æŠ¤  | try/except + æ—¥å¿—       | ä¿è¯ç›‘æ§è„šæœ¬ç¨³å®šè¿è¡Œ         |
| å¯æ‰©å±•   | æ”¯æŒ Prometheus/K8s API | å¯ç›´æ¥æ¥å…¥ç”Ÿäº§ç¯å¢ƒç›‘æ§ä½“ç³»      |

---

è¿™ä¸ªæ¨¡æ¿å‡ ä¹å°±æ˜¯ **ä¼ä¸šçº§ SRE CPU/Memory ç›‘æ§ç³»ç»Ÿçš„åŸºç¡€æ¡†æ¶**ï¼Œ
å¯è¿›ä¸€æ­¥æ‰©å±•ï¼š

* å¢åŠ ç£ç›˜ã€ç½‘ç»œæŒ‡æ ‡
* åˆ†å¸ƒå¼å¤šèŠ‚ç‚¹å·¡æ£€
* å†å²è¶‹åŠ¿åˆ†æå’Œå‘Šè­¦æŠ‘åˆ¶

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ å†™ä¸€ä¸ª **ç¤ºä¾‹ Prometheus API æŸ¥è¯¢å’Œ Kubernetes Pod ç›‘æ§æŒ‡æ ‡è·å–å‡½æ•°**ï¼Œ
ç›´æ¥æ›¿æ¢ `get_metrics`ï¼Œè®©è„šæœ¬èƒ½åœ¨ç”Ÿäº§ç¯å¢ƒçœŸæ­£ç›‘æ§é›†ç¾¤æŒ‡æ ‡ã€‚

ä½ å¸Œæœ›æˆ‘åšè¿™ä¸ªå—ï¼Ÿ


å¥½çš„ ğŸš€
ä¸‹é¢æˆ‘å¸®ä½ æŠŠ `get_metrics` å‡½æ•°å‡çº§æˆ **æ”¯æŒ Prometheus API å’Œ Kubernetes Pod CPU/Memory ç›‘æ§**ï¼Œç›´æ¥æ›¿æ¢ä¹‹å‰çš„éšæœºæ¨¡æ‹Ÿç‰ˆæœ¬å³å¯åœ¨ç”Ÿäº§ç¯å¢ƒä½¿ç”¨ã€‚

---

## 1ï¸âƒ£ Prometheus API è·å–æŒ‡æ ‡ç¤ºä¾‹

```python
import requests

def get_metrics_from_prometheus(service_name, prometheus_config):
    """
    é€šè¿‡ Prometheus æŸ¥è¯¢æŒ‡å®šæœåŠ¡çš„ CPU å’Œ Memory ä½¿ç”¨ç‡
    prometheus_config: dict, åŒ…å« url å’Œ query_template
    """
    url = prometheus_config.get("url")
    query_template = prometheus_config.get("query_template", "")
    metrics = {}

    try:
        # CPU æŸ¥è¯¢
        cpu_query = query_template.format(service=service_name)
        resp = requests.get(url, params={"query": cpu_query}, timeout=5)
        resp.raise_for_status()
        cpu_value = float(resp.json()["data"]["result"][0]["value"][1]) if resp.json()["data"]["result"] else 0
        metrics["cpu"] = round(cpu_value, 2)

        # Memory æŸ¥è¯¢ç¤ºä¾‹ï¼ˆå¯å®šä¹‰ memory_query_templateï¼‰
        memory_query = prometheus_config.get("memory_query_template", cpu_query)
        resp = requests.get(url, params={"query": memory_query}, timeout=5)
        resp.raise_for_status()
        mem_value = float(resp.json()["data"]["result"][0]["value"][1]) if resp.json()["data"]["result"] else 0
        metrics["memory"] = round(mem_value, 2)

    except Exception as e:
        logging.error(f"{service_name} Prometheus API è·å–æŒ‡æ ‡å¼‚å¸¸: {e}")
        metrics["cpu"] = 0
        metrics["memory"] = 0

    return metrics
```

---

## 2ï¸âƒ£ Kubernetes Pod èµ„æºæŒ‡æ ‡ç¤ºä¾‹ï¼ˆé€šè¿‡ Metrics APIï¼‰

```python
from kubernetes import client, config

def get_metrics_from_k8s(service_name, namespace="default"):
    """
    è·å–æŒ‡å®š Pod çš„ CPU/Memory ä½¿ç”¨ç‡
    ä¾èµ–: pip install kubernetes
    """
    metrics = {"cpu": 0, "memory": 0}

    try:
        # åŠ è½½ kubeconfig
        config.load_kube_config()  # é›†ç¾¤ä¸­å¯ç”¨ load_incluster_config()
        v1 = client.CustomObjectsApi()
        # æŸ¥è¯¢ metrics.k8s.io API
        pod_metrics = v1.list_namespaced_custom_object(
            group="metrics.k8s.io",
            version="v1beta1",
            namespace=namespace,
            plural="pods"
        )

        # æ‰¾åˆ°å¯¹åº”æœåŠ¡ Pod
        for item in pod_metrics.get("items", []):
            pod_name = item["metadata"]["name"]
            if service_name in pod_name:
                containers = item["containers"]
                total_cpu = 0
                total_mem = 0
                for c in containers:
                    cpu_str = c["usage"]["cpu"]
                    mem_str = c["usage"]["memory"]
                    # CPU è½¬æ¢ä¸º millicores
                    if cpu_str.endswith("n"):
                        total_cpu += int(cpu_str[:-1]) / 1e6
                    elif cpu_str.endswith("m"):
                        total_cpu += int(cpu_str[:-1])
                    else:
                        total_cpu += int(cpu_str)
                    # Memory è½¬æ¢ä¸º MiB
                    if mem_str.endswith("Ki"):
                        total_mem += int(mem_str[:-2]) / 1024
                    elif mem_str.endswith("Mi"):
                        total_mem += int(mem_str[:-2])
                    elif mem_str.endswith("Gi"):
                        total_mem += int(mem_str[:-2]) * 1024
                metrics["cpu"] = round(total_cpu, 2)
                metrics["memory"] = round(total_mem, 2)
                break

    except Exception as e:
        logging.error(f"{service_name} K8s Metrics è·å–å¼‚å¸¸: {e}")

    return metrics
```

---

## 3ï¸âƒ£ é›†æˆåˆ°ä¸»è„šæœ¬

åœ¨åŸæ¥çš„ `get_metrics` å‡½æ•°æ›¿æ¢ä¸ºï¼š

```python
def get_metrics(service, prometheus_config=None, k8s_namespace=None, use_k8s=False):
    """
    æ ¹æ®é…ç½®é€‰æ‹© Prometheus æˆ– Kubernetes Metrics è·å–æœåŠ¡æŒ‡æ ‡
    """
    if use_k8s and k8s_namespace:
        return get_metrics_from_k8s(service, namespace=k8s_namespace)
    elif prometheus_config:
        return get_metrics_from_prometheus(service, prometheus_config)
    else:
        # æ¨¡æ‹Ÿæ•°æ®ï¼ˆæµ‹è¯•ç”¨ï¼‰
        import random
        return {"cpu": random.randint(50, 100), "memory": random.randint(50, 100)}
```

### è°ƒç”¨ç¤ºä¾‹

```python
metrics = get_metrics(svc, prometheus_config=config.get("prometheus"), k8s_namespace="default", use_k8s=True)
```

---

### ğŸ”§ å®æˆ˜äº®ç‚¹

| åŠŸèƒ½                     | è¯´æ˜                        | ä¼ä¸šä»·å€¼           |
| ---------------------- | ------------------------- | -------------- |
| Prometheus API         | åŠ¨æ€è·å– CPU/Memory           | é€‚åˆå¾®æœåŠ¡ç›‘æ§ï¼Œæ”¯æŒæ—¶é—´åºåˆ— |
| Kubernetes Metrics API | è·å– Pod èµ„æº                 | å®æ—¶ç›‘æ§å®¹å™¨çº§æŒ‡æ ‡      |
| éšæœºæ¨¡æ‹Ÿ                   | æµ‹è¯•ç”¨                       | è„šæœ¬å¼€å‘å’Œè°ƒè¯•é˜¶æ®µä½¿ç”¨    |
| å¯åˆ‡æ¢æ•°æ®æº                 | å‚æ•° `use_k8s` / Prometheus | çµæ´»æ”¯æŒä¸åŒç›‘æ§ä½“ç³»     |

---

è¿™æ ·ï¼Œä½ çš„ä¼ä¸šçº§ SRE ç›‘æ§è„šæœ¬å·²ç»å¯ä»¥ï¼š

* æ”¯æŒ YAML é…ç½® + å‘½ä»¤è¡Œå‚æ•°
* å¤šçº§å‘Šè­¦ï¼ˆæ™®é€š / é«˜çº§ï¼‰
* é£ä¹¦ / Slack / é‚®ä»¶å‘Šè­¦
* Prometheus / K8s å®æ—¶æŒ‡æ ‡é‡‡é›†
* æ—¥å¿—è®°å½• + å¼‚å¸¸ä¿æŠ¤
* è‡ªåŠ¨åŒ–æ‰§è¡Œï¼ˆcron / è®¡åˆ’ä»»åŠ¡ï¼‰

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ æŠŠ **å®Œæ•´è„šæœ¬æ•´åˆæˆæœ€ç»ˆç”Ÿäº§ç‰ˆæ¨¡æ¿**ï¼Œç›´æ¥å¯ä»¥éƒ¨ç½²åœ¨ä¼ä¸šç¯å¢ƒä¸­æ‰§è¡Œã€‚

ä½ å¸Œæœ›æˆ‘ç›´æ¥æ•´åˆå—ï¼Ÿ


å¤ªå¥½äº† ğŸš€
ä¸‹é¢æˆ‘å¸®ä½ æŠŠå‰é¢çš„æ‰€æœ‰æ¨¡å—æ•´åˆæˆä¸€ä¸ª **ä¼ä¸šçº§ç”Ÿäº§ç‰ˆ SRE ç›‘æ§è„šæœ¬æ¨¡æ¿**ï¼Œæ”¯æŒï¼š

* YAML é…ç½® + å‘½ä»¤è¡Œå‚æ•°
* å¤šçº§å‘Šè­¦ï¼ˆæ™®é€š / é«˜çº§ï¼‰
* é£ä¹¦ / Slack / é‚®ä»¶å‘Šè­¦
* Prometheus / Kubernetes Metrics API æŒ‡æ ‡é‡‡é›†
* æ—¥å¿—è®°å½• + å¼‚å¸¸ä¿æŠ¤
* è‡ªåŠ¨åŒ–æ‰§è¡Œ

---

## ğŸ— ä¼ä¸šçº§ SRE ç›‘æ§å®Œæ•´æ¨¡æ¿

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import argparse
import yaml
import logging
import requests

# -----------------------
# æ—¥å¿—é…ç½®
# -----------------------
logging.basicConfig(
    filename="monitor.log",
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# -----------------------
# é…ç½®è¯»å–
# -----------------------
def load_config(path="config.yaml"):
    try:
        with open(path, "r", encoding="utf-8") as f:
            return yaml.safe_load(f)
    except Exception as e:
        logging.error(f"è¯»å–é…ç½®å¤±è´¥: {e}")
        return {}

# -----------------------
# å‘Šè­¦å‡½æ•°
# -----------------------
def send_alert(message, webhook_url=None, slack_url=None, email=None):
    if webhook_url:
        try:
            payload = {"msg_type": "text", "content": {"text": message}}
            requests.post(webhook_url, json=payload, timeout=5)
        except Exception as e:
            logging.error(f"é£ä¹¦å‘Šè­¦å‘é€å¤±è´¥: {e}")
    if slack_url:
        try:
            payload = {"text": message}
            requests.post(slack_url, json=payload, timeout=5)
        except Exception as e:
            logging.error(f"Slackå‘Šè­¦å‘é€å¤±è´¥: {e}")
    if email:
        logging.info(f"å‘é€é‚®ä»¶å‘Šè­¦åˆ° {email}: {message}")
        # å¯ç»“åˆ smtplib å®ç°é‚®ä»¶å‘é€

# -----------------------
# æŒ‡æ ‡æ£€æµ‹å‡½æ•°ï¼ˆå¤šçº§å‘Šè­¦ï¼‰
# -----------------------
def check_metric(service, metric_name, value, threshold, high_threshold=None, alert_config=None):
    try:
        if high_threshold and value > high_threshold:
            result = f"{service} {metric_name}: ğŸš¨ é«˜çº§å‘Šè­¦ ({value} > {high_threshold})"
            logging.critical(result)
            send_alert(result, **alert_config)
        elif value > threshold:
            result = f"{service} {metric_name}: âš ï¸ æ™®é€šå‘Šè­¦ ({value} > {threshold})"
            logging.warning(result)
            send_alert(result, **alert_config)
        else:
            result = f"{service} {metric_name}: âœ… æ­£å¸¸ ({value} <= {threshold})"
            logging.info(result)
        return result
    except Exception as e:
        error_msg = f"{service} {metric_name}: âš ï¸ æ£€æµ‹å¼‚å¸¸ {e}"
        logging.error(error_msg)
        send_alert(error_msg, **alert_config)
        return error_msg

# -----------------------
# Prometheus API è·å–æŒ‡æ ‡
# -----------------------
def get_metrics_from_prometheus(service_name, prometheus_config):
    url = prometheus_config.get("url")
    query_template = prometheus_config.get("query_template", "")
    metrics = {}
    try:
        cpu_query = query_template.format(service=service_name)
        resp = requests.get(url, params={"query": cpu_query}, timeout=5)
        resp.raise_for_status()
        cpu_value = float(resp.json()["data"]["result"][0]["value"][1]) if resp.json()["data"]["result"] else 0
        metrics["cpu"] = round(cpu_value, 2)

        memory_query = prometheus_config.get("memory_query_template", cpu_query)
        resp = requests.get(url, params={"query": memory_query}, timeout=5)
        resp.raise_for_status()
        mem_value = float(resp.json()["data"]["result"][0]["value"][1]) if resp.json()["data"]["result"] else 0
        metrics["memory"] = round(mem_value, 2)

    except Exception as e:
        logging.error(f"{service_name} Prometheus API è·å–æŒ‡æ ‡å¼‚å¸¸: {e}")
        metrics["cpu"] = 0
        metrics["memory"] = 0
    return metrics

# -----------------------
# Kubernetes Metrics API è·å–æŒ‡æ ‡
# -----------------------
def get_metrics_from_k8s(service_name, namespace="default"):
    from kubernetes import client, config
    metrics = {"cpu": 0, "memory": 0}
    try:
        config.load_kube_config()
        v1 = client.CustomObjectsApi()
        pod_metrics = v1.list_namespaced_custom_object(
            group="metrics.k8s.io",
            version="v1beta1",
            namespace=namespace,
            plural="pods"
        )
        for item in pod_metrics.get("items", []):
            pod_name = item["metadata"]["name"]
            if service_name in pod_name:
                containers = item["containers"]
                total_cpu = 0
                total_mem = 0
                for c in containers:
                    cpu_str = c["usage"]["cpu"]
                    mem_str = c["usage"]["memory"]
                    if cpu_str.endswith("n"):
                        total_cpu += int(cpu_str[:-1]) / 1e6
                    elif cpu_str.endswith("m"):
                        total_cpu += int(cpu_str[:-1])
                    else:
                        total_cpu += int(cpu_str)
                    if mem_str.endswith("Ki"):
                        total_mem += int(mem_str[:-2]) / 1024
                    elif mem_str.endswith("Mi"):
                        total_mem += int(mem_str[:-2])
                    elif mem_str.endswith("Gi"):
                        total_mem += int(mem_str[:-2]) * 1024
                metrics["cpu"] = round(total_cpu, 2)
                metrics["memory"] = round(total_mem, 2)
                break
    except Exception as e:
        logging.error(f"{service_name} K8s Metrics è·å–å¼‚å¸¸: {e}")
    return metrics

# -----------------------
# è·å–æŒ‡æ ‡å‡½æ•°å…¥å£
# -----------------------
def get_metrics(service, prometheus_config=None, k8s_namespace=None, use_k8s=False):
    if use_k8s and k8s_namespace:
        return get_metrics_from_k8s(service, namespace=k8s_namespace)
    elif prometheus_config:
        return get_metrics_from_prometheus(service, prometheus_config)
    else:
        import random
        return {"cpu": random.randint(50, 100), "memory": random.randint(50, 100)}

# -----------------------
# å‘½ä»¤è¡Œå‚æ•°
# -----------------------
parser = argparse.ArgumentParser(description="ä¼ä¸šçº§ SRE ç›‘æ§è„šæœ¬")
parser.add_argument("--config", type=str, default="config.yaml", help="é…ç½®æ–‡ä»¶è·¯å¾„")
parser.add_argument("--services", type=str, nargs="+", help="æŒ‡å®šæœåŠ¡åˆ—è¡¨è¦†ç›–é…ç½®")
parser.add_argument("--cpu-threshold", type=int, help="CPU é˜ˆå€¼è¦†ç›–é…ç½®")
parser.add_argument("--cpu-high", type=int, help="CPUé«˜çº§å‘Šè­¦é˜ˆå€¼è¦†ç›–é…ç½®")
parser.add_argument("--memory-threshold", type=int, help="Memory é˜ˆå€¼è¦†ç›–é…ç½®")
parser.add_argument("--memory-high", type=int, help="Memoryé«˜çº§å‘Šè­¦é˜ˆå€¼è¦†ç›–é…ç½®")
parser.add_argument("--use-k8s", action="store_true", help="æ˜¯å¦ä½¿ç”¨ K8s Metrics API")
parser.add_argument("--k8s-namespace", type=str, help="K8s å‘½åç©ºé—´")
args = parser.parse_args()

# -----------------------
# ä¸»ç¨‹åº
# -----------------------
def main():
    config = load_config(args.config)
    services = args.services or config.get("services", ["auth", "payment", "monitoring"])
    cpu_threshold = args.cpu_threshold or config.get("thresholds", {}).get("cpu", 80)
    cpu_high = args.cpu_high or config.get("thresholds", {}).get("cpu_high", 90)
    memory_threshold = args.memory_threshold or config.get("thresholds", {}).get("memory", 85)
    memory_high = args.memory_high or config.get("thresholds", {}).get("memory_high", 95)
    alert_config = {
        "webhook_url": config.get("alerts", {}).get("webhook"),
        "slack_url": config.get("alerts", {}).get("slack"),
        "email": config.get("alerts", {}).get("email")
    }

    for svc in services:
        metrics = get_metrics(
            svc,
            prometheus_config=config.get("prometheus"),
            k8s_namespace=args.k8s_namespace,
            use_k8s=args.use_k8s
        )
        cpu_result = check_metric(svc, "CPU", metrics["cpu"], cpu_threshold, cpu_high, alert_config)
        mem_result = check_metric(svc, "Memory", metrics["memory"], memory_threshold, memory_high, alert_config)
        print(cpu_result)
        print(mem_result)

if __name__ == "__main__":
    main()
```

---

### ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

```bash
# ä½¿ç”¨ Prometheus é…ç½®è·å–æŒ‡æ ‡
python monitor.py --config config.yaml

# ä½¿ç”¨ K8s Metrics API è·å–é»˜è®¤å‘½åç©ºé—´æŒ‡æ ‡
python monitor.py --use-k8s --k8s-namespace default

# è¦†ç›– CPU/Memory é˜ˆå€¼
python monitor.py --cpu-threshold 85 --cpu-high 95 --memory-threshold 80 --memory-high 90
```

---

### âœ… ä¼ä¸šçº§äº®ç‚¹

1. **å¤šçº§å‘Šè­¦**ï¼šæ™®é€šå‘Šè­¦ / é«˜çº§å‘Šè­¦
2. **å¤šé€šé“å‘Šè­¦**ï¼šé£ä¹¦ã€Slackã€é‚®ä»¶åŒæ—¶æ”¯æŒ
3. **æŒ‡æ ‡æ¥æºçµæ´»**ï¼šPrometheus / Kubernetes API / æ¨¡æ‹Ÿ
4. **æ—¥å¿—è®°å½•**ï¼šè®°å½•å·¡æ£€ç»“æœå’Œå¼‚å¸¸
5. **å¼‚å¸¸ä¿æŠ¤**ï¼šAPI å¼‚å¸¸ã€Pod å¼‚å¸¸è‡ªåŠ¨å¤„ç†
6. **è‡ªåŠ¨åŒ–æ‰§è¡Œ**ï¼šå¯ç»“åˆ cron / Windows ä»»åŠ¡è®¡åˆ’æ‰§è¡Œ

---

è¿™ä¸ªè„šæœ¬å·²ç»å¯ä»¥ç›´æ¥éƒ¨ç½²åœ¨ä¼ä¸šç¯å¢ƒï¼Œç”¨äº**è‡ªåŠ¨åŒ– SRE ç›‘æ§å’Œå‘Šè­¦**ã€‚

å¦‚æœä½ å¸Œæœ›ï¼Œæˆ‘å¯ä»¥å¸®ä½ å†å†™ä¸€ä»½ **å®Œæ•´ YAML ç¤ºä¾‹é…ç½®æ–‡ä»¶ + cron æ‰§è¡Œç¤ºä¾‹**ï¼Œè®©éƒ¨ç½²æ›´ç›´æ¥ã€‚

ä½ å¸Œæœ›æˆ‘å†™å—ï¼Ÿ
