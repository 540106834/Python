太棒了 🚀
我们进入 **阶段 1 - 第 3 节：函数与模块（构建可复用监控函数）**。

---

## 🧩 第 3 节：函数与模块

> 🎯 目标：让监控脚本**更结构化、可复用、可维护**

---

### 💡 为什么 SRE 必须掌握函数？

在 SRE 监控中，你会经常做这些事：

* 检查多个服务健康状态
* 采集多个节点指标
* 发送告警消息
* 定时轮询检查

👉 如果这些逻辑都直接写在主程序里，会非常混乱。
用 **函数 (function)** 能让每个任务单独封装、独立运行。

---

## 🧠 1. 函数基础语法

```python
def check_service(name, code):
    """检查单个服务状态"""
    if code == 200:
        print(f"{name}: ✅ 正常")
    else:
        print(f"{name}: ⚠️ 异常，请检查服务！（status={code}）")
```

> 💬 `def` 定义函数
> 📘 `name, code` 是参数
> 🧾 `""" ... """` 是函数文档字符串（docstring）

---

## 🔁 2. 在主程序中调用函数

```python
services = ["auth", "payment", "monitoring"]
status_codes = [200, 503, 200]

for name, code in zip(services, status_codes):
    check_service(name, code)
```

✅ 输出：

```
auth: ✅ 正常
payment: ⚠️ 异常，请检查服务！（status=503）
monitoring: ✅ 正常
```

---

## 📦 3. 函数返回值（return）

让函数返回结果，而不是直接打印。

```python
def check_service(name, code):
    if code == 200:
        return f"{name}: ✅ 正常"
    else:
        return f"{name}: ⚠️ 异常 (status={code})"

results = []

for name, code in zip(services, status_codes):
    result = check_service(name, code)
    results.append(result)

print("\n".join(results))
```

> 💡 返回值的写法非常重要：
> 实际中你可能会把返回值写入日志文件、数据库或发送到消息系统（如飞书、Slack）。

---

## 🔧 4. 模块化（module）

如果你的脚本越来越多，可以把常用函数放在独立文件里：

```
monitor_utils.py
main.py
```

### `monitor_utils.py`

```python
def check_service(name, code):
    if code == 200:
        return f"{name}: ✅ 正常"
    else:
        return f"{name}: ⚠️ 异常 (status={code})"
```

### `main.py`

```python
from monitor_utils import check_service

services = ["auth", "payment", "monitoring"]
status_codes = [200, 503, 200]

for name, code in zip(services, status_codes):
    print(check_service(name, code))
```

✅ 这样做可以轻松维护一整套监控函数库。

---

## 🧩 小练习

请你写一个函数：

> 名称：`check_cpu(usage, threshold)`
> 逻辑：
>
> * 如果 `usage > threshold` → 返回 `"⚠️ CPU 超过阈值！当前 {usage}%"`
> * 否则 → 返回 `"✅ CPU 正常，当前 {usage}%"`

要求：
调用 3 次函数，分别传入 72、85、60（阈值设为 80），打印每次结果。

---

是否希望我接下来：
A. 给出练习答案 + 讲解
B. 继续进入下一节（文件与日志操作 — 保存监控结果）


好的 👍 我们来完成 **`check_cpu` 函数练习**，并讲解每一步在 SRE 脚本中的实际意义。

---

## 🧩 练习题：CPU 检测函数

**要求回顾：**

* 函数名称：`check_cpu(usage, threshold)`
* 逻辑：

  * `usage > threshold` → 返回 `"⚠️ CPU 超过阈值！当前 {usage}%"`
  * 否则 → 返回 `"✅ CPU 正常，当前 {usage}%"`
* 调用三次：72、85、60，阈值 80
* 打印结果

---

### ✅ 参考答案

```python
def check_cpu(usage, threshold):
    """检查CPU使用率是否超过阈值"""
    if usage > threshold:
        return f"⚠️ CPU 超过阈值！当前 {usage}%"
    else:
        return f"✅ CPU 正常，当前 {usage}%"

# 阈值
cpu_threshold = 80

# 测试数据
cpu_list = [72, 85, 60]

# 调用函数并打印结果
for cpu in cpu_list:
    result = check_cpu(cpu, cpu_threshold)
    print(result)
```

---

### 💡 输出结果

```
✅ CPU 正常，当前 72%
⚠️ CPU 超过阈值！当前 85%
✅ CPU 正常，当前 60%
```

---

### 🧠 知识点讲解

| 知识点      | 说明                  | SRE 实战意义            |
| -------- | ------------------- | ------------------- |
| `def`    | 定义函数                | 将检查逻辑封装，便于重复调用      |
| `return` | 返回结果                | 可以灵活处理（打印、写日志、发送告警） |
| `for` 循环 | 批量调用函数              | 方便一次检查多个节点或服务       |
| 参数传递     | `usage`、`threshold` | 灵活指定不同的监控指标和阈值      |

---

### 🔧 进阶思路

1. 可以把函数改造成返回 **布尔值 + 文本**，方便告警逻辑二次处理：

```python
def check_cpu(usage, threshold):
    if usage > threshold:
        return False, f"⚠️ CPU 超过阈值！当前 {usage}%"
    else:
        return True, f"✅ CPU 正常，当前 {usage}%"
```

2. 返回值可直接写入日志或发送告警系统（飞书/Slack/邮件）。

---

接下来，我们可以进入 **阶段 1 的最后一节**：

**「文件与日志操作 — 保存监控结果」** 📝

> 让你的监控脚本不仅能检测，还能把结果写入日志或配置文件，以便审计和历史分析。

是否继续？
