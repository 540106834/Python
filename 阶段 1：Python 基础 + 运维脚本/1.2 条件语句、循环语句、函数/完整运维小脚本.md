å¤ªå¥½äº† ğŸ˜„
ä¸‹é¢æˆ‘å¸®ä½ å†™ä¸€ä¸ª **é˜¶æ®µ 1 çš„å®Œæ•´è¿ç»´å°è„šæœ¬**ï¼ŒæŠŠæˆ‘ä»¬å‰é¢å­¦çš„ **æ¡ä»¶åˆ¤æ–­ + å¾ªç¯ + å‡½æ•° + æ—¥å¿— + æ¨¡æ‹ŸæŒ‡æ ‡** å…¨éƒ¨ç»“åˆèµ·æ¥ï¼Œè®©ä½ è¾¹å­¦è¾¹å®è·µã€‚

---

# ğŸ é˜¶æ®µ 1 å®æˆ˜è„šæœ¬ï¼šå¤šæœåŠ¡ CPU/Memory æ¨¡æ‹Ÿç›‘æ§

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-

import logging
import random
from datetime import datetime

# -----------------------
# æ—¥å¿—é…ç½®
# -----------------------
logging.basicConfig(
    filename="monitor.log",
    level=logging.INFO,
    format="%(asctime)s - %(levelname)s - %(message)s"
)

# -----------------------
# å‡½æ•°ï¼šæ£€æŸ¥ CPU
# -----------------------
def check_cpu(cpu):
    """æ ¹æ® CPU ä½¿ç”¨ç‡è¿”å›å‘Šè­¦ç­‰çº§"""
    if cpu > 90:
        return "ğŸš¨ CPU é«˜çº§å‘Šè­¦"
    elif cpu > 80:
        return "âš ï¸ CPU æ™®é€šå‘Šè­¦"
    else:
        return "âœ… CPU æ­£å¸¸"

# -----------------------
# å‡½æ•°ï¼šæ£€æŸ¥å†…å­˜
# -----------------------
def check_memory(memory):
    """æ ¹æ®å†…å­˜ä½¿ç”¨ç‡è¿”å›å‘Šè­¦ç­‰çº§"""
    if memory > 90:
        return "ğŸš¨ å†…å­˜é«˜çº§å‘Šè­¦"
    elif memory > 80:
        return "âš ï¸ å†…å­˜æ™®é€šå‘Šè­¦"
    else:
        return "âœ… å†…å­˜æ­£å¸¸"

# -----------------------
# å‡½æ•°ï¼šæ£€æŸ¥æœåŠ¡çŠ¶æ€
# -----------------------
def check_service(service, cpu, memory):
    """æ£€æŸ¥æœåŠ¡ CPU å’Œå†…å­˜ï¼Œå¹¶å†™å…¥æ—¥å¿—"""
    cpu_result = check_cpu(cpu)
    mem_result = check_memory(memory)

    log_msg = f"{service}: CPU={cpu}%, Memory={memory}% | {cpu_result} | {mem_result}"
    logging.info(log_msg)
    print(log_msg)

# -----------------------
# ä¸»ç¨‹åº
# -----------------------
def main():
    # æ¨¡æ‹ŸæœåŠ¡åˆ—è¡¨
    services = ["auth", "payment", "monitoring"]

    # å¾ªç¯éå†æ¯ä¸ªæœåŠ¡
    for svc in services:
        # æ¨¡æ‹Ÿ CPU / Memory ä½¿ç”¨ç‡ (50-100)
        cpu_usage = random.randint(50, 100)
        memory_usage = random.randint(50, 100)

        # æ£€æŸ¥æœåŠ¡çŠ¶æ€
        check_service(svc, cpu_usage, memory_usage)

    # æ¨¡æ‹Ÿ while å¾ªç¯å€’è®¡æ—¶ç¤ºä¾‹
    countdown = 5
    while countdown > 0:
        print(f"ä¸‹æ¬¡ç›‘æ§å€’è®¡æ—¶: {countdown} ç§’")
        countdown -= 1

if __name__ == "__main__":
    main()
```

---

## âœ… è„šæœ¬äº®ç‚¹

1. **æ¡ä»¶åˆ¤æ–­**ï¼šæ ¹æ® CPU/Memory ä½¿ç”¨ç‡è¾“å‡ºå¤šçº§å‘Šè­¦
2. **å¾ªç¯**ï¼šéå†æœåŠ¡åˆ—è¡¨ï¼ŒåŒæ—¶æ¼”ç¤º while å€’è®¡æ—¶
3. **å‡½æ•°å°è£…**ï¼š`check_cpu`, `check_memory`, `check_service`
4. **æ—¥å¿—è®°å½•**ï¼šæ¯æ¬¡è¿è¡Œéƒ½ä¼šå†™å…¥ `monitor.log`
5. **æ¨¡æ‹ŸæŒ‡æ ‡**ï¼šéšæœºç”Ÿæˆ CPU/Memory æ•°å€¼ï¼Œä¾¿äºç»ƒä¹ 

---

## ğŸ”§ è¿è¡Œç¤ºä¾‹

```bash
python monitor_stage1.py
```

**æ§åˆ¶å°è¾“å‡ºç¤ºä¾‹**

```
auth: CPU=85%, Memory=72% | âš ï¸ CPU æ™®é€šå‘Šè­¦ | âœ… å†…å­˜æ­£å¸¸
payment: CPU=92%, Memory=88% | ğŸš¨ CPU é«˜çº§å‘Šè­¦ | âš ï¸ å†…å­˜æ™®é€šå‘Šè­¦
monitoring: CPU=65%, Memory=95% | âœ… CPU æ­£å¸¸ | ğŸš¨ å†…å­˜é«˜çº§å‘Šè­¦
ä¸‹æ¬¡ç›‘æ§å€’è®¡æ—¶: 5 ç§’
ä¸‹æ¬¡ç›‘æ§å€’è®¡æ—¶: 4 ç§’
...
```

**æ—¥å¿—æ–‡ä»¶ monitor.log**

```
2025-10-26 09:49:23,456 - INFO - auth: CPU=85%, Memory=72% | âš ï¸ CPU æ™®é€šå‘Šè­¦ | âœ… å†…å­˜æ­£å¸¸
2025-10-26 09:49:23,457 - INFO - payment: CPU=92%, Memory=88% | ğŸš¨ CPU é«˜çº§å‘Šè­¦ | âš ï¸ å†…å­˜æ™®é€šå‘Šè­¦
2025-10-26 09:49:23,457 - INFO - monitoring: CPU=65%, Memory=95% | âœ… CPU æ­£å¸¸ | ğŸš¨ å†…å­˜é«˜çº§å‘Šè­¦
```

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½ æŠŠ **è¿™ä¸ªè„šæœ¬å‡çº§åˆ°é˜¶æ®µ 2**ï¼š
åŠ å…¥ **YAML é…ç½® + å‘½ä»¤è¡Œå‚æ•°è¦†ç›–é˜ˆå€¼ + å¼‚å¸¸å¤„ç†**ï¼Œæ›´æ¥è¿‘ SRE ç›‘æ§å®æˆ˜è„šæœ¬ã€‚

ä½ å¸Œæœ›æˆ‘å¸®ä½ å‡çº§å—ï¼Ÿ


æ˜ç™½äº†ï¼Œæˆ‘å¸®ä½ æŠŠä¹‹å‰çš„å®Œæ•´è¿ç»´å°è„šæœ¬å‡çº§ä¸º **æ”¯æŒ YAML é…ç½® + å‘½ä»¤è¡Œå‚æ•°è¦†ç›–é˜ˆå€¼ + å¼‚å¸¸ä¿æŠ¤** çš„ç‰ˆæœ¬ï¼ŒåŒæ—¶ä¿ç•™ CPU/å†…å­˜/ç£ç›˜æ£€æŸ¥ã€æ—¥å¿—è½®è½¬ã€HTTP è¯·æ±‚ç­‰åŠŸèƒ½ã€‚

---

# **å®Œæ•´è¿ç»´è„šæœ¬ï¼ˆå¸¦ YAML é…ç½® + CLI å‚æ•° + å¼‚å¸¸å¤„ç†ï¼‰**

```python
import os
import shutil
import time
import psutil
import requests
import yaml
import argparse
import sys

# --------------------------
# å‡½æ•°å®šä¹‰
# --------------------------

def load_config(yaml_file):
    """åŠ è½½ YAML é…ç½®"""
    try:
        with open(yaml_file, "r") as f:
            config = yaml.safe_load(f)
        return config
    except FileNotFoundError:
        print(f"é…ç½®æ–‡ä»¶ {yaml_file} æœªæ‰¾åˆ°ï¼Œä½¿ç”¨é»˜è®¤é…ç½®")
        return {}
    except yaml.YAMLError as e:
        print(f"YAML è§£æé”™è¯¯: {e}")
        return {}

def check_cpu(threshold):
    try:
        cpu = psutil.cpu_percent(interval=1)
        if cpu < threshold * 0.6:
            status = "æ­£å¸¸"
        elif cpu < threshold:
            status = "åé«˜"
        else:
            status = "è¿‡é«˜"
        return cpu, status
    except Exception as e:
        print(f"æ£€æŸ¥ CPU å‡ºé”™: {e}")
        return None, "æœªçŸ¥"

def check_memory(threshold):
    try:
        mem = psutil.virtual_memory().percent
        if mem < threshold * 0.6:
            status = "æ­£å¸¸"
        elif mem < threshold:
            status = "åé«˜"
        else:
            status = "è¿‡é«˜"
        return mem, status
    except Exception as e:
        print(f"æ£€æŸ¥å†…å­˜å‡ºé”™: {e}")
        return None, "æœªçŸ¥"

def check_disks(threshold):
    alerts = []
    try:
        for part in psutil.disk_partitions():
            usage = psutil.disk_usage(part.mountpoint).percent
            if usage > threshold:
                alerts.append(f"{part.mountpoint} ä½¿ç”¨ç‡ {usage}% è¶…è¿‡é˜ˆå€¼")
    except Exception as e:
        alerts.append(f"ç£ç›˜æ£€æŸ¥å‡ºé”™: {e}")
    return alerts

def rotate_logs(log_dir, max_files=5):
    try:
        archive_dir = os.path.join(log_dir, "archive")
        os.makedirs(archive_dir, exist_ok=True)
        
        logs = sorted([f for f in os.listdir(log_dir) if f.endswith(".log")])
        while len(logs) > max_files:
            oldest = logs.pop(0)
            shutil.move(os.path.join(log_dir, oldest), os.path.join(archive_dir, oldest))
            print(f"å·²å½’æ¡£æ—¥å¿—: {oldest}")
    except Exception as e:
        print(f"æ—¥å¿—è½®è½¬å‡ºé”™: {e}")

def fetch_url(url, retries=3):
    for attempt in range(1, retries+1):
        try:
            response = requests.get(url, timeout=5)
            response.raise_for_status()
            return response.text
        except requests.RequestException as e:
            print(f"ç¬¬ {attempt} æ¬¡è¯·æ±‚å¤±è´¥: {e}")
            time.sleep(1)
    return None

# --------------------------
# ä¸»æµç¨‹
# --------------------------

def main():
    # ----------------------
    # å‘½ä»¤è¡Œå‚æ•°è§£æ
    # ----------------------
    parser = argparse.ArgumentParser(description="è¿ç»´ç›‘æ§è„šæœ¬")
    parser.add_argument("--config", default="config.yaml", help="YAML é…ç½®æ–‡ä»¶è·¯å¾„")
    parser.add_argument("--cpu", type=int, help="CPU å‘Šè­¦é˜ˆå€¼")
    parser.add_argument("--mem", type=int, help="å†…å­˜å‘Šè­¦é˜ˆå€¼")
    parser.add_argument("--disk", type=int, help="ç£ç›˜å‘Šè­¦é˜ˆå€¼")
    args = parser.parse_args()

    # ----------------------
    # åŠ è½½ YAML é…ç½®
    # ----------------------
    config = load_config(args.config)
    cpu_threshold = args.cpu or config.get("cpu_threshold", 80)
    mem_threshold = args.mem or config.get("mem_threshold", 70)
    disk_threshold = args.disk or config.get("disk_threshold", 80)
    log_dir = config.get("log_dir", "./logs")
    max_log_files = config.get("max_log_files", 5)
    url = config.get("url", "http://example.com/api/health")
    retries = config.get("http_retries", 3)

    # ----------------------
    # ç³»ç»Ÿèµ„æºæ£€æŸ¥
    # ----------------------
    print("=== ç³»ç»Ÿèµ„æºæ£€æŸ¥ ===")
    cpu_val, cpu_status = check_cpu(cpu_threshold)
    print(f"CPU ä½¿ç”¨ç‡: {cpu_val}% çŠ¶æ€: {cpu_status}")

    mem_val, mem_status = check_memory(mem_threshold)
    print(f"å†…å­˜ä½¿ç”¨ç‡: {mem_val}% çŠ¶æ€: {mem_status}")

    disk_alerts = check_disks(disk_threshold)
    if disk_alerts:
        for alert in disk_alerts:
            print(alert)
    else:
        print("ç£ç›˜ä½¿ç”¨æ­£å¸¸")

    # ----------------------
    # æ—¥å¿—è½®è½¬
    # ----------------------
    print("\n=== æ—¥å¿—è½®è½¬ ===")
    rotate_logs(log_dir, max_files)

    # ----------------------
    # HTTP è¯·æ±‚æ£€æµ‹
    # ----------------------
    print("\n=== HTTP è¯·æ±‚æ£€æµ‹ ===")
    result = fetch_url(url, retries)
    if result:
        print("HTTP è¯·æ±‚æˆåŠŸ")
    else:
        print("HTTP è¯·æ±‚å¤±è´¥")

# --------------------------
# æ‰§è¡Œè„šæœ¬
# --------------------------

if __name__ == "__main__":
    main()
```

---

# **YAML é…ç½®ç¤ºä¾‹ (`config.yaml`)**

```yaml
cpu_threshold: 75
mem_threshold: 70
disk_threshold: 80
log_dir: ./logs
max_log_files: 5
url: http://example.com/api/health
http_retries: 3
```

---

# **è„šæœ¬è¯´æ˜**

1. **YAML é…ç½®**

   * æ”¯æŒ CPU/å†…å­˜/ç£ç›˜é˜ˆå€¼ã€æ—¥å¿—ç›®å½•ã€HTTP URL ç­‰å‚æ•°
   * `load_config` å‡½æ•°è¯»å–é…ç½®æ–‡ä»¶

2. **å‘½ä»¤è¡Œå‚æ•°è¦†ç›–**

   * `--cpu`, `--mem`, `--disk` å¯è¦†ç›– YAML ä¸­é˜ˆå€¼
   * ä½¿ç”¨ `argparse` å®ç°

3. **å¼‚å¸¸ä¿æŠ¤**

   * æ¯ä¸ªå‡½æ•°éƒ½åŠ  `try/except` æ•è·å¼‚å¸¸
   * é¿å…å•ç‚¹å¤±è´¥å¯¼è‡´è„šæœ¬ä¸­æ–­

4. **åŠŸèƒ½è¦†ç›–**

   * CPU/å†…å­˜/ç£ç›˜å‘Šè­¦æ£€æŸ¥
   * æ—¥å¿—è½®è½¬
   * HTTP è¯·æ±‚é‡è¯•

5. **æ‰©å±•æ€§**

   * å¯æ‰¹é‡ç›‘æ§å¤šå°æœåŠ¡å™¨
   * å¯ç»“åˆå®šæ—¶ä»»åŠ¡(cron)å®ç°å®šæœŸæ‰§è¡Œ

---

å¦‚æœä½ æ„¿æ„ï¼Œæˆ‘å¯ä»¥å¸®ä½  **ç”»ä¸€å¼ è„šæœ¬æ‰§è¡Œæµç¨‹å›¾**ï¼Œå¯è§†åŒ– **é…ç½®åŠ è½½ â†’ é˜ˆå€¼è§£æ â†’ èµ„æºæ£€æŸ¥ â†’ æ—¥å¿—è½®è½¬ â†’ HTTP æ£€æµ‹ â†’ å¼‚å¸¸å¤„ç†** çš„æµç¨‹ï¼Œè®©æ•´ä¸ªé€»è¾‘æ›´æ¸…æ™°ã€‚

ä½ å¸Œæœ›æˆ‘ç”»å—ï¼Ÿ
