# **Python 异常处理 `try / except / finally` 的完整讲解 + 常用写法示例**


#  一、基本结构

```python
try:
    # 可能发生异常的代码
except ExceptionType:
    # 出错时执行
finally:
    # 无论是否发生异常都执行
```

作用关系：

| 块         | 是否必写 | 作用             |
| --------- | ---- | -------------- |
| `try`     | 必写   | 包含可能会出错的代码     |
| `except`  | 可选   | 捕获异常并处理        |
| `finally` | 可选   | 总是执行，常用于关闭资源   |
| `else`    | 可选   | 当 **没有异常** 时执行 |

---

#  二、最常用用法

## 1. 捕获特定异常

```python
try:
    result = 10 / 0
except ZeroDivisionError:
    print("除以零错误！")
```

---

## 2. 捕获多个异常

```python
try:
    x = int("abc")
except (ValueError, TypeError):
    print("数据类型转换错误！")
```

---

## 3. 捕获所有异常（不推荐滥用）

```python
try:
    x = 10 / 0
except Exception as e:
    print("发生异常：", e)
```

这会捕获所有标准异常，适合日志记录，但不要用于隐藏问题。

---

#  三、finally：总是执行

常用于：

* 关闭文件
* 关闭数据库连接
* 释放锁
* 清理资源

例如读取文件：

```python
try:
    f = open("app.log", "r", encoding="utf-8")
    data = f.read()
except FileNotFoundError:
    print("文件不存在")
finally:
    if 'f' in locals():
        f.close()   # 无论如何都执行
```

---

#  四、try + except + else

`else` 在 **没有异常** 时执行，非常干净的写法。

```python
try:
    x = int("123")
except ValueError:
    print("不是数字")
else:
    print("转换成功：", x)
```

---

#  五、try/except 嵌套

```python
try:
    try:
        x = 10 / 0
    except ZeroDivisionError:
        print("内部捕获：除零")
except Exception:
    print("外部处理其他异常")
```

---

#  六、实际案例：读写文件

### ✔ 读取文本（你最近问的日志案例）

```python
try:
    with open("app.log", "r", encoding="utf-8") as f:
        for line in f:
            print(line.strip())
except FileNotFoundError:
    print("日志文件不存在")
```

`with` 会自动关闭文件，不需要 finally。

---

### ✔ 写 JSON 文件（你最近做的 config.json 示例）

```python
import json

data = {"service": "web", "status": "running", "port": 80}

try:
    with open("config.json", "w", encoding="utf-8") as f:
        json.dump(data, f, ensure_ascii=False, indent=4)
except OSError as e:
    print("文件写入失败：", e)
else:
    print("写入成功")
```

---

#  七、为什么 finally 这么重要？

因为即使：

* 发生异常
* return 或 break
* 程序主动退出（除 kill -9）

`finally` 都会执行。

示例：

```python
def test():
    try:
        return "try return"
    finally:
        print("finally 执行！")

print(test())
```

输出：

```
finally 执行！
try return
```

---

# 如果你愿意，我可以帮你继续：

* 写一个 Exception 类继承，做自定义异常？
* 演示日志记录 + try/except？
* 写你要用的 Alertmanager / Prometheus 相关异常处理示例？

告诉我你要哪个方向继续 👍
